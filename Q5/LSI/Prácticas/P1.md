### a) Configure su máquina virtual de laboratorio con los datos proporcionados por el profesor. Analice los ficheros básicos de configuración (interfaces, hosts, resolv.conf, nsswitch.conf, sources.list, etc.)
##### Fichero /etc/network/interfaces
Se utiliza para configurar la red, es decir, definir las interfaces de red, asignar direcciones IP, configurar rutas, etc.
```
auto lo ens33
iface lo inet loopback
iface ens33 inet static
        address 10.11.49.56/23
        gateway 10.11.48.1
        dns-nameservers 10.8.12.47 10.8.12.49 10.8.12.50

auto lo ens34
iface lo inet loopback
iface ens34 inet static
        address 10.11.51.56/23

auto 6to4
iface 6to4 inet6 v4tunnel
        address 2002:0a0b:3138::
        netmask 16
        gateway ::10.11.48.1
        endpoint any
        local 10.11.49.56

```

auto: al arrancar el sistema
inet static: ip estática
inet6 v4tunnel: túnel para poder transmitir a ipv4
endpoint any: acepta conexiones entrantes desde cualquier dirección IP remota


##### Fichero /etc/hosts
Es un archivo de configuración utilizado para mapear nombres de host a direcciones IP sin tener que depender de un servidor DNS. Añadimos a Ivanna al fichero de hosts.
```
127.0.0.1       localhost
127.0.1.1       debian
10.11.51.49     Ivanna

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

```

##### Fichero /etc/resolv.conf
Se utiliza para especificar los servidores DNS.

```
domain udc.pri
search udc.pri
nameserver 10.8.12.49
nameserver 10.8.12.50
nameserver 10.8.12.47

```


##### Fichero /etc/nsswitch.conf
Controla la secuencia en la que se buscan las fuentes de información para la resolución de nombres y otros servicios de administración del sistema.

```
passwd:         files systemd
group:          files systemd
shadow:         files
gshadow:        files

hosts:          files mdns4_minimal [NOTFOUND=return] dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
```

##### Fichero /etc/apt/sources.list
Sirve para especificar los repositorios de software desde los cuales el sistema obtendrá paquetes y actualizaciones

```
deb http://deb.debian.org/debian/ bookworm main
deb-src http://deb.debian.org/debian/ bookworm main

deb http://security.debian.org/debian-security bookworm-security/updates main contrib
deb-src http://security.debian.org/debian-security bookworm-security/updates main contrib

# buster-updates, previously known as 'volatile'
deb http://deb.debian.org/debian/ bookworm-updates main contrib
deb-src http://deb.debian.org/debian/ bookworm-updates main contrib

```


### b) ¿Qué distro y versión tiene la máquina inicialmente entregada?. Actualice su máquina a la última versión estable disponible.
uname -a
```
Linux ivan32 6.1.0-12-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.52-1 (2023-09-07) x86_64 GNU/Linux
```

uname -r
```
6.1.0-12-amd64
```

 cat /etc/os-release
```
 PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"
NAME="Debian GNU/Linux"
VERSION_ID="12"
VERSION="12 (bookworm)"
VERSION_CODENAME=bookworm
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"
```
##### Versiones:
debian 10 v4.19.0 buster (versión inicial)
debian 11 v5.10.0 bullseye
debian 12 v6.1.0 bookworm

##### Actualización:
apt update
apt upgrade
Cambios en los repositorios de /etc/apt/sources.list
apt update
apt upgrade
apt autoremove

### c) Identifique la secuencia completa de arranque de una máquina basada en la distribución de referencia (desde la pulsación del botón de arranque hasta la pantalla de login). ¿Qué target por defecto tiene su máquina?.¿Cómo podría cambiar el target de arranque? ¿Qué targets tiene su sistema y en qué estado se encuentran?.¿Y los services?. Obtenga la relación de servicios de su sistema y su estado. ¿Qué otro tipo de unidades existen?
systemd-analyze blame
```
3.205s networking.service
2.945s systemd-journal-flush.service
2.319s dev-sda1.device
2.308s user@1000.service
2.008s ifupdown-pre.service
1.444s dbus.service
1.186s rsyslog.service
1.131s systemd-logind.service
1.033s ssh.service
 805ms scripti.service
 685ms systemd-udev-trigger.service
 560ms systemd-binfmt.service
 553ms systemd-journald.service
 468ms systemd-update-utmp.service
 447ms systemd-tmpfiles-clean.service
```

systemctl set-default multi-user.target
systemctl get-default
```
multi-user.target
```

systemctl list-units --type=target
```
 UNIT                  LOAD   ACTIVE SUB    DESCRIPTION
  basic.target          loaded active active Basic System
  cryptsetup.target     loaded active active Local Encrypted Volumes
  getty.target          loaded active active Login Prompts
  integritysetup.target loaded active active Local Integrity Protected Volumes
  local-fs-pre.target   loaded active active Preparation for Local File Systems
  local-fs.target       loaded active active Local File Systems
  multi-user.target     loaded active active Multi-User System
  network.target        loaded active active Network
  paths.target          loaded active active Path Units
  remote-fs.target      loaded active active Remote File Systems
  slices.target         loaded active active Slice Units
  sockets.target        loaded active active Socket Units
  swap.target           loaded active active Swaps
  sysinit.target        loaded active active System Initialization
  timers.target         loaded active active Timer Units
  veritysetup.target    loaded active active Local Verity Protected Volumes
```

systemctl list-unit-files --type=service
```
UNIT FILE                              STATE           PRESET
alsa-restore.service                   static          -
alsa-state.service                     static          -
alsa-utils.service                     masked          enabled
anacron.service                        enabled         enabled
apparmor.service                       masked          enabled
apt-daily-upgrade.service              static          -
apt-daily.service                      static          -
autovt@.service                        alias           -
bluetooth.service                      masked          disabled
colord.service                         static          -
console-getty.service                  disabled        disabled
console-setup.service                  enabled         enabled
container-getty@.service               static          -
cron.service                           enabled         enabled
cryptdisks-early.service               masked          enabled
cryptdisks.service                     masked          enabled
dbus-org.freedesktop.hostname1.service alias           -
dbus-org.freedesktop.locale1.service   alias           -
dbus-org.freedesktop.login1.service    alias           -
dbus-org.freedesktop.timedate1.service alias           -
dbus-org.freedesktop.timesync1.service bad             enabled
dbus.service                           static          -
debug-shell.service                    disabled        disabled
dpkg-db-backup.service                 static          -
e2scrub@.service                       static          -
e2scrub_all.service                    static          -
e2scrub_fail@.service                  static          -
e2scrub_reap.service                   masked          enabled
emergency.service                      static          -
fstrim.service                         static          -
geoclue.service                        static          -
getty-static.service                   static          -
getty@.service                         enabled         enabled
hwclock.service                        masked          enabled
ifup@.service                          static          -
ifupdown-pre.service                   static          -
ifupdown-wait-online.service           disabled        enabled
iio-sensor-proxy.service               static          -

```

systemctl list-units --type=service
```
 console-setup.service              loaded active exited  Set console font and keymap
  cron.service                       loaded active running Regular background program processing daemon
  dbus.service                       loaded active running D-Bus System Message Bus
  getty@tty1.service                 loaded active running Getty on tty1
  ifupdown-pre.service               loaded active exited  Helper to synchronize boot up for ifupdown
  kmod-static-nodes.service          loaded active exited  Create List of Static Device Nodes
  low-memory-monitor.service         loaded active running Low Memory Monitor
  networking.service                 loaded active exited  Raise network interfaces
  ntpsec.service                     loaded active running Network Time Service
  rsyslog.service                    loaded active running System Logging Service
  scripti.service                    loaded active exited  Script que crea un archivo de logs
  ssh.service                        loaded active running OpenBSD Secure Shell server
  systemd-binfmt.service             loaded active exited  Set Up Additional Binary Formats
  systemd-journal-flush.service      loaded active exited  Flush Journal to Persistent Storage
  systemd-journald.service           loaded active running Journal Service
  systemd-logind.service             loaded active running User Login Management
  systemd-modules-load.service       loaded active exited  Load Kernel Modules
  systemd-random-seed.service        loaded active exited  Load/Save Random Seed
  systemd-remount-fs.service         loaded active exited  Remount Root and Kernel File Systems
  systemd-sysctl.service             loaded active exited  Apply Kernel Variables
  systemd-sysusers.service           loaded active exited  Create System Users
  systemd-tmpfiles-setup-dev.service loaded active exited  Create Static Device Nodes in /dev
  systemd-tmpfiles-setup.service     loaded active exited  Create Volatile Files and Directories
  systemd-udev-trigger.service       loaded active exited  Coldplug All udev Devices
  systemd-udevd.service              loaded active running Rule-based Manager for Device Events and Files
  systemd-update-utmp.service        loaded active exited  Record System Boot/Shutdown in UTMP
  systemd-user-sessions.service      loaded active exited  Permit User Sessions
  user-runtime-dir@1000.service      loaded active exited  User Runtime Directory /run/user/1000
  user@1000.service                  loaded active running User Manager for UID 1000

```

##### Otras unidades
+ **Unidades de montaje (mount units):** Estas unidades se utilizan para definir puntos de montaje para sistemas de archivos. Controlan el montaje y desmontaje de sistemas de archivos en el sistema.
+ **Unidades de dispositivo (device units):** Las unidades de dispositivo representan dispositivos de hardware individuales y se utilizan para configurar y controlar el comportamiento de hardware específico.
+ **Unidades de socket (socket units):** Estas unidades representan sockets de red o archivos de socket UNIX. Pueden utilizarse para configurar sockets de red y controlar la activación de servicios cuando se recibe tráfico en un socket.
+ **Unidades de timer (timer units):** Las unidades de timer se utilizan para programar tareas y ejecutar servicios o comandos en momentos específicos o con intervalos regulares.
+ **Unidades de snapshot (snapshot units):** Estas unidades permiten guardar y restaurar instantáneas del estado actual del sistema systemd. Son útiles para realizar copias de seguridad del estado del sistema o para revertir a estados anteriores.
+ **Unidades de slice (slice units):** Las unidades de slice se utilizan para agrupar procesos en "rebanadas" o "slices" con el fin de gestionar la asignación de recursos del sistema, como la CPU y la memoria, entre grupos de procesos.
+ **Unidades de scope (scope units):** Las unidades de scope son utilizadas para agrupar procesos relacionados y gestionar su ciclo de vida. Pueden ser útiles para crear entornos de ejecución aislados para aplicaciones.
+ **Unidades de path (path units):** Las unidades de path permiten activar servicios cuando se producen cambios en archivos o directorios específicos. Son útiles para automatizar acciones basadas en eventos de sistema de archivos.
+ **Unidades de swap (swap units):** Estas unidades se utilizan para configurar y controlar dispositivos de intercambio (swap) en el sistema.



### d) Determine los tiempos aproximados de botado de su kernel y del userspace. Obtenga la relación de los tiempos de ejecución de los services de su sistema.
systemd-analyze
```
Startup finished in 4.520s (kernel) + 10.407s (userspace) = 14.928s
multi-user.target reached after 10.362s in userspace.
```

systemd-analyze critical-chain
```
multi-user.target @10.362s
└─ssh.service @9.328s +1.033s
  └─network.target @9.318s
    └─networking.service @6.107s +3.205s
      └─ifupdown-pre.service @4.087s +2.008s
        └─systemd-udev-trigger.service @3.382s +685ms
          └─systemd-udevd-kernel.socket @3.279s
            └─system.slice @3.259s
              └─-.slice @3.259s
```

### e) Investigue si alguno de los servicios del sistema falla. Pruebe algunas de las opciones del sistema de registro journald. Obtenga toda la información journald referente al proceso de botado de la máquina. ¿Qué hace el systemd-timesyncd?
journalctl -b
```
nov 12 21:08:09 ivan32 systemd[823]: Queued start job for default target default.target.
nov 12 21:08:09 ivan32 systemd[823]: Created slice app.slice - User Application Slice.
nov 12 21:08:09 ivan32 systemd[823]: Reached target paths.target - Paths.
nov 12 21:08:09 ivan32 systemd[823]: Reached target timers.target - Timers.
nov 12 21:08:09 ivan32 systemd[823]: Starting dbus.socket - D-Bus User Message Bus Socket...
nov 12 21:08:09 ivan32 systemd[823]: Listening on dirmngr.socket - GnuPG network certificate management daemon.
nov 12 21:08:09 ivan32 systemd[823]: Listening on gcr-ssh-agent.socket - GCR ssh-agent wrapper.
nov 12 21:08:09 ivan32 systemd[823]: Listening on gpg-agent-browser.socket - GnuPG cryptographic agent and passphrase cache (access for web browsers).
nov 12 21:08:09 ivan32 systemd[823]: Listening on gpg-agent-extra.socket - GnuPG cryptographic agent and passphrase cache (restricted).
nov 12 21:08:09 ivan32 systemd[823]: Listening on gpg-agent-ssh.socket - GnuPG cryptographic agent (ssh-agent emulation).
nov 12 21:08:09 ivan32 systemd[823]: Listening on gpg-agent.socket - GnuPG cryptographic agent and passphrase cache.
nov 12 21:08:09 ivan32 systemd[823]: Listening on pk-debconf-helper.socket - debconf communication socket.
nov 12 21:08:09 ivan32 systemd[823]: Listening on dbus.socket - D-Bus User Message Bus Socket.
nov 12 21:08:09 ivan32 systemd[823]: Reached target sockets.target - Sockets.
nov 12 21:08:09 ivan32 systemd[823]: Reached target basic.target - Basic System.
nov 12 21:08:10 ivan32 systemd[823]: Reached target default.target - Main User Target.
nov 12 21:08:10 ivan32 systemd[823]: Startup finished in 1.886s.
nov 12 21:08:18 ivan32 su[862]: (to root) lsi on pts/0
nov 12 21:08:18 ivan32 su[862]: pam_unix(su:session): session opened for user root(uid=0) by lsi(uid=1000)
nov 12 21:09:38 ivan32 su[862]: pam_unix(su:session): session closed for user root
```

journalctl -b -p4
```
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'cpu cycles' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'instructions' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'bus cycles' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'cache references' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'cache misses' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'branch instructions' unavailable
nov 12 21:07:52 ivan32 kernel: core: CPUID marked event: 'branch misses' unavailable
nov 12 21:07:52 ivan32 kernel: ENERGY_PERF_BIAS: Set to 'normal', was 'performance'
nov 12 21:07:53 ivan32 kernel: piix4_smbus 0000:00:07.3: SMBus Host Controller not enabled!
nov 12 21:07:53 ivan32 kernel: device-mapper: core: CONFIG_IMA_DISABLE_HTABLE is disabled. Duplicate IMA measurements will not be recorded in the IMA log.
nov 12 21:07:55 ivan32 (udev-worker)[362]: id: Truncating stdout of 'dmi_memory_id' up to 16384 byte.
nov 12 21:08:00 ivan32 rsyslogd[563]: Invalid protocol 'TCP 127.0.0.1' in allowed sender list, line ignored [v8.2302.0]
nov 12 21:08:00 ivan32 rsyslogd[563]: error: extra characters in config line ignored: '10.11.49.49' [v8.2302.0]
nov 12 21:08:09 ivan32 ntpd[814]: CLOCK: time stepped by 0.803905
```

##### Systemd-timesync
Systemd-timesync es un componente de systemd que proporciona sincronización de tiempo para el sistema, lo que significa que se encarga de mantener el reloj del sistema en sincronía con una fuente de tiempo precisa, como un servidor de tiempo de red.

systemctl status systemd-timesyncd
```
Unit systemd-timesyncd.service could not be found.
```


### f) Identifique y cambie los principales parámetros de su segundo interface de red (ens34). Configure un segundo interface lógico. Al terminar, déjelo como estaba.
ifconfig ens34:0 10.11.52.1/24
ifconfig ens34:0 up
ifconfig
```
ens34:0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.11.52.1  netmask 255.255.255.0  broadcast 10.11.52.255
        ether 00:50:56:97:77:61  txqueuelen 1000  (Ethernet)
        device interrupt 16  base 0x2080

```

ifconfig ens34:0 down

### g) ¿Qué rutas (routing) están definidas en su sistema?. Incluya una nueva ruta estática a una determinada red. h) En el apartado d) se ha familiarizado con los services que corren en su sistema. ¿Son necesarios todos ellos?. Si identifica servicios no necesarios, proceda adecuadamente. Una limpieza no le vendrá mal a su equipo, tanto desde el punto de vista de la seguridad, como del rendimiento.
ip route show
```
default via 10.11.48.1 dev ens33 onlink
10.11.48.0/23 dev ens33 proto kernel scope link src 10.11.49.56
10.11.50.0/23 dev ens34 proto kernel scope link src 10.11.51.56
169.254.0.0/16 dev ens33 scope link metric 1000
```

route -n
```
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.11.48.1      0.0.0.0         UG    0      0        0 ens33
10.11.48.0      0.0.0.0         255.255.254.0   U     0      0        0 ens33
10.11.50.0      0.0.0.0         255.255.254.0   U     0      0        0 ens34
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 ens33

```

##### Añadir y eliminar una ruta
ip route add 10.11.52.0/23 via 10.11.48.1
ip route del 10.11.52.0/23

### h) En el apartado d) se ha familiarizado con los services que corren en su sistema. ¿Son necesarios todos ellos? Si identifica servicios no necesarios, proceda adecuadamente. Una limpieza no le vendrá mal a su equipo, tanto desde el punto de vista de la seguridad, como del rendimiento.
Para recargar los servicios:
systemctl daemon-reload

Desactivación de bluetooth:
systemctl disable bluetooth && systemctl mask bluetooth
BLUETOOTH_ENABLED=0 en /etc/default/bluetooth
AutoEnabled=false en /etc/bluetooth/main.conf

Desactivación de cups (impresoras):
systemctl disable cups && systemctl mask cups
disable cups-browsed && systemctl mask cups-browsed

Desactivación de avahi-daemon:
systemctl disable avahi-daemon && systemctl mask avahi-daemon

Desactivación de daemon-reload:
systemctl disable accounts-daemon && systemctl mask accounts-daemon

Desactivación de NetworkManager:
systemctl disable NetworkManager && systemctl mask NetworkManager

Desactivación de ModemManager:
systemctl disable ModemManager && systemctl mask ModemManager

Desactivación de AppArmor:
systemctl disable apparmor

Desactivación de e2scrub_reap:
systemctl disable e2scrub_reap && systemctl mask e2scrub_reap

Desactivación de keyboard_setup:
systemctl disable keyboard_setup && systemctl mask keyboard_setup

Desactivación de open-vm-tools:
systemctl disable open-vm-tools && systemctl mask open-vm-tools

Desactivación de WPA:
systemctl disable wpa_supplicant-nl80211@ && systemctl mask wpa_supplicant-nl80211@
systemctl disable wpa_supplicant-wired@ && systemctl mask wpa_supplicant-wired@
systemctl disable wpa_supplicant@ && systemctl mask wpa_supplicant@
systemctl disable wpa_supplicant && systemctl mask wpa_supplicant

Se puede desactivar el PRESET en /lib/systemd/system-preset/90-systemd.preset


### i) Diseñe y configure un pequeño “script” y defina la correspondiente unidad de tipo service para que se ejecute en el proceso de botado de su máquina. 
nano /usr/local/bin/scripti.sh
```
#!/bin/bash

# Directorio donde se creará el archivo de registro
log_dir="/var/log/mi_script_logs"

# Nombre del archivo de registro
log_file="registro_inicio.txt"

# Verifica si el directorio de registro existe, y si no, créalo
if [ ! -d "$log_dir" ]; then
    mkdir -p "$log_dir"
fi

# Ruta completa al archivo de registro
log_path="$log_dir/$log_file"

# Mensaje de inicio
timestamp=$(date +"%Y-%m-%d %H:%M:%S")
message="El sistema se ha iniciado en $timestamp"

# Registra el mensaje de inicio en el archivo de registro
echo "$message" >> "$log_path"

# Puedes agregar cualquier otra tarea que desees realizar al inicio aquí

exit 0
```

nano /etc/systemd/system/scripti.service
```
[Unit]
Description=Script que crea un archivo de logs

[Service]
ExecStart=/usr/local/bin/scripti.sh
Type=oneshot
RemainAfterExit=yes
StandardOutput=journal

[Install]
WantedBy=multi-user.target

```

+ **Type=oneshot:** El servicio se define como de tipo "oneshot", lo que significa que se ejecutará una vez y luego se considerará terminado. Esto es apropiado para tareas que no se ejecutan en segundo plano de forma continua.
+ **RemainAfterExit=yes:** Esta línea indica que, aunque el servicio se ejecute solo una vez (tipo "oneshot"), systemd debe considerarlo como "activo" incluso después de que termine la ejecución del script. Esto se usa comúnmente para servicios que realizan una acción que tiene un efecto duradero, como la creación de archivos de logs.
+ **StandardOutput=journal:** Aquí se especifica dónde se dirigirá la salida estándar (stdout) del script. En este caso, se redirigirá al registro del sistema (journal), que es una característica de systemd para el registro de eventos y mensajes del sistema.

### j) Identifique las conexiones de red abiertas a y desde su equipo. 
netstat -netua
```
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State                                                                                         User       Inode
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN                                                                                        0          14561
tcp        0      0 0.0.0.0:514             0.0.0.0:*               LISTEN                                                                                        0          14327
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN                                                                                        1000       14942
tcp        0      0 10.11.49.56:22          10.30.9.74:49877        ESTABLISHED                                                                                   0          14670
tcp        0    180 10.11.49.56:22          10.30.9.74:49875        ESTABLISHED                                                                                   0          14607
tcp        0      0 10.11.49.56:514         10.11.49.49:48092       ESTABLISHED                                                                                   0          15585
tcp6       0      0 :::22                   :::*                    LISTEN                                                                                        0          14572
tcp6       0      0 :::514                  :::*                    LISTEN                                                                                        0          14328
tcp6       0      0 ::1:6010                :::*                    LISTEN                                                                                        1000       14941
udp        0      0 10.11.51.56:123         0.0.0.0:*                                                                                                             0          14516
udp        0      0 10.11.49.56:123         0.0.0.0:*                                                                                                             0          14514
udp        0      0 127.0.0.1:123           0.0.0.0:*                                                                                                             0          14512
udp        0      0 0.0.0.0:123             0.0.0.0:*                                                                                                             0          14508
udp6       0      0 ::10.11.49.56:123       :::*                                                                                                                  0          14526
udp6       0      0 2002:a0b:3138:::123     :::*                                                                                                                  0          14524
udp6       0      0 fe80::250:56ff:fe97:123 :::*                                                                                                                  0          14522
udp6       0      0 fe80::250:56ff:fe97:123 :::*                                                                                                                  0          14520
udp6       0      0 ::1:123                 :::*                                                                                                                  0          14518
udp6       0      0 :::123                  :::*                                                                                                                  0          14505

```

### k) Nuestro sistema es el encargado de gestionar la CPU, memoria, red, etc., como soporte a los datos y procesos. Monitorice en “tiempo real” la información relevante de los procesos del sistema y los recursos consumidos. Monitorice en “tiempo real” las conexiones de su sistema. 
##### Procesos
top
```
   7 root      20   0       0      0      0 I   0,3   0,0   0:05.29 kworker+
    956 root      20   0   11824   5596   3440 R   0,3   0,4   0:00.08 top
      1 root      20   0   20520  12464   9132 S   0,0   0,8   0:02.09 systemd
      2 root      20   0       0      0      0 S   0,0   0,0   0:00.00 kthreadd
      3 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 rcu_par+
      5 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 slub_fl+
      6 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 netns
     10 root       0 -20       0      0      0 I   0,0   0,0   0:00.00 mm_perc+
     11 root      20   0       0      0      0 I   0,0   0,0   0:00.00 rcu_tas+
     12 root      20   0       0      0      0 I   0,0   0,0   0:00.00 rcu_tas+
     13 root      20   0       0      0      0 I   0,0   0,0   0:00.00 rcu_tas+
     14 root      20   0       0      0      0 S   0,0   0,0   0:00.11 ksoftir+
     15 root      20   0       0      0      0 I   0,0   0,0   0:00.35 rcu_pre+
     16 root      rt   0       0      0      0 S   0,0   0,0   0:00.03 migrati+
     18 root      20   0       0      0      0 S   0,0   0,0   0:00.00 cpuhp/0

```

##### Conexiones a tiempo real
netstat -netuac
```
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      0          14561
tcp        0      0 0.0.0.0:514             0.0.0.0:*               LISTEN      0          14327
tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      1000       14942
tcp        0      0 10.11.49.56:22          10.30.9.74:49877        ESTABLISHED 0          14670
tcp        0      0 10.11.49.56:22          10.30.9.74:49875        ESTABLISHED 0          14607
tcp        0      0 10.11.49.56:514         10.11.49.49:48092       ESTABLISHED 0          15585
tcp6       0      0 :::22                   :::*                    LISTEN      0          14572
tcp6       0      0 :::514                  :::*                    LISTEN      0          14328
tcp6       0      0 ::1:6010                :::*                    LISTEN      1000       14941
udp        0      0 10.11.51.56:123         0.0.0.0:*                           0          14516
udp        0      0 10.11.49.56:123         0.0.0.0:*                           0          14514
udp        0      0 127.0.0.1:123           0.0.0.0:*                           0          14512
udp        0      0 0.0.0.0:123             0.0.0.0:*                           0          14508
udp6       0      0 ::10.11.49.56:123       :::*                                0          14526
udp6       0      0 2002:a0b:3138:::123     :::*                                0          14524
udp6       0      0 fe80::250:56ff:fe97:123 :::*                                0          14522
udp6       0      0 fe80::250:56ff:fe97:123 :::*                                0          14520
udp6       0      0 ::1:123                 :::*                                0          14518
udp6       0      0 :::123                  :::*                                0          14505

```

### l) Un primer nivel de filtrado de servicios los constituyen los tcp-wrappers. Configure el tcpwrapper de su sistema (basado en los ficheros hosts.allow y hosts.deny) para permitir conexiones SSH a un determinado conjunto de IPs y denegar al resto. ¿Qué política general de filtrado ha aplicado?. ¿Es lo mismo el tcp-wrapper que un firewall?. Procure en este proceso no perder conectividad con su máquina. No se olvide que trabaja contra ella en remoto por ssh. 
##### Política
Denegamos todo y aceptamos solo determinados rangos de IPS.

nano /etc/hosts.allow
```
# localhost, loopback
sshd: 127.0.0.1, 10.11.49.56, 10.11.51.56: spawn echo "$(date) conexión de %a a                                                                                   %A PERMITIDA"  >> /var/log/conexiones
# ivanna
sshd: 10.11.49.49: spawn echo "$(date) conexión de %a a %A PERMITIDA"  >> /var/l                                                                                  og/conexiones
# vpn udc:
sshd: 10.30.8.0/255.255.248.0:  spawn echo "$(date) conexión de %a a %A PERMITID                                                                                  A"  >> /var/log/conexiones
# eduroam:
sshd: 10.20.32.0/255.255.248.0:  spawn echo "$(date) conexión de %a a %A PERMITI                                                                                  DA"  >> /var/log/conexiones
# ipv6:
sshd: [::1], [2002:0a0b:3131::], [2002:0a0b:3138::]:  spawn echo "$(date) conexi                                                                                  ón de %a a %A PERMITIDA"  >> /var/log/conexiones
# rsyslog:
rsyslogd: 10.11.49.49: spawn echo "$(date) conexión de %a a %A PERMITIDA"  >> /v                                                                                  ar/log/conexiones

```

nano /etc/hosts.deny
```
ALL: ALL: spawn echo "$(date) Conexión de %a a %A es DENEGADA">> /var/log/conexiones
```

##### Diferencia entre firewall y tcp-wrappers
Un firewall y los TCP Wrappers son dos enfoques diferentes para controlar y gestionar el acceso a servicios de red en un sistema, pero tienen diferencias significativas en cuanto a cómo funcionan y qué ofrecen. Aquí te presento las diferencias clave entre un firewall y los TCP Wrappers:

1. **Función Principal**:
   - **Firewall**: Un firewall es un sistema de seguridad de red que controla el tráfico de red entrante y saliente según reglas específicas. Su función principal es filtrar y bloquear o permitir conexiones en función de diversas condiciones, como direcciones IP, puertos y protocolos.
   - **TCP Wrappers**: Los TCP Wrappers son una herramienta de control de acceso en host que se utiliza para permitir o denegar el acceso a servicios de red específicos en función de direcciones IP o nombres de host. No es un firewall completo, sino una forma más simple de controlar el acceso a servicios individuales en un sistema.

2. **Granularidad**:
   - **Firewall**: Los firewalls pueden aplicar reglas de filtrado a nivel de puerto, dirección IP, protocolo y otros criterios. Pueden controlar el acceso a nivel de sistema, filtrar tráfico de red en general y proporcionar seguridad a nivel de red.
   - **TCP Wrappers**: Los TCP Wrappers se centran en servicios específicos y permiten un control más granular sobre qué hosts o redes pueden acceder a un servicio en particular. Se utilizan principalmente para controlar el acceso a servicios de red específicos, como SSH, FTP o telnet.

3. **Ubicación**:
   - **Firewall**: Los firewalls se pueden implementar a nivel de red y pueden estar en dispositivos independientes (firewalls de hardware) o en el sistema operativo (firewalls de software). Pueden proteger toda la red.
   - **TCP Wrappers**: Los TCP Wrappers operan en el nivel de aplicación y están implementados en el sistema operativo del servidor que ofrece el servicio. Controlan el acceso solo a los servicios en el servidor donde están configurados.

4. **Complejidad**:
   - **Firewall**: Los firewalls son sistemas más complejos que pueden gestionar múltiples reglas y políticas de seguridad. Pueden proporcionar un conjunto más amplio de funciones de seguridad de red.
   - **TCP Wrappers**: Los TCP Wrappers son más simples en comparación con los firewalls. Se centran en el control de acceso a servicios de red específicos y son más adecuados para tareas de control de acceso en host.

En resumen, la principal diferencia radica en su alcance y enfoque. Los firewalls son sistemas de seguridad de red más amplios y versátiles que controlan el tráfico de red en general, mientras que los TCP Wrappers son herramientas más simples que se centran en el control de acceso a servicios de red individuales en un host específico.

### m) Existen múltiples paquetes para la gestión de logs (syslog, syslog-ng, rsyslog). Utilizando el rsyslog pruebe su sistema de log local. Pruebe también el journald. 
logger "hola"
tail -1 /var/log/mis_logs.log

### n) Configure IPv6 6to4 y pruebe ping6 y ssh sobre dicho protocolo. ¿Qué hace su tcp-wrapper en las conexiones ssh en IPv6? Modifique su tcp-wapper siguiendo el criterio del apartado h). ¿Necesita IPv6?. ¿Cómo se deshabilita IPv6 en su equipo?
cat /etc/network/interfaces
```
auto 6to4
iface 6to4 inet6 v4tunnel
        address 2002:0a0b:3138::
        netmask 16
        gateway ::10.11.48.1
        endpoint any
        local 10.11.49.56
```

Añadir estas líneas en /etc/sysctl.conf (0 enable, 1 disable)
```
net.ipv6.conf.all.disable_ipv6=0
net.ipv6.conf.default.disable_ipv6=0
net.ipv6.conf.lo.disable_ipv6=0
```

ifup6to4
ping6 2002:0a0b:3138::
```
PING 2002:0a0b:3138::(2002:a0b:3138::) 56 data bytes
64 bytes from 2002:a0b:3138::: icmp_seq=1 ttl=64 time=0.042 ms
```

### a) En colaboración con otro alumno de prácticas, configure un servidor y un cliente NTPSec básico.
nano /etc/ntpsec/ntp.conf
```
# /etc/ntpsec/ntp.conf, configuration for ntpd; see ntp.conf(5) for help

driftfile /var/lib/ntpsec/ntp.drift
leapfile /usr/share/zoneinfo/leap-seconds.list

# To enable Network Time Security support as a server, obtain a certificate
# (e.g. with Let's Encrypt), configure the paths below, and uncomment:
# nts cert CERT_FILE
# nts key KEY_FILE
# nts enable

# You must create /var/log/ntpsec (owned by ntpsec:ntpsec) to enable logging.
#statsdir /var/log/ntpsec/
#statistics loopstats peerstats clockstats
#filegen loopstats file loopstats type day enable
#filegen peerstats file peerstats type day enable
#filegen clockstats file clockstats type day enable

# This should be maxclock 7, but the pool entries count towards maxclock.
tos maxclock 11

# Comment this out if you have a refclock and want it to be able to discipline
# the clock by itself (e.g. if the system is not connected to the network).
tos minclock 4 minsane 1

# Specify one or more NTP servers.
#server 10.11.49.56

# Public NTP servers supporting Network Time Security:
# server time.cloudflare.com nts

server 10.11.49.49 prefer iburst

#server 127.127.1.1 minpoll 4
#fudge  127.127.1.1 stratum 10


# pool.ntp.org maps to about 1000 low-stratum NTP servers.  Your server will
# pick a different set every time it starts up.  Please consider joining the
# pool: <https://www.pool.ntp.org/join.html>
#pool 0.debian.pool.ntp.org iburst
#pool 1.debian.pool.ntp.org iburst
#pool 2.debian.pool.ntp.org iburst
#pool 3.debian.pool.ntp.org iburst

# Access control configuration; see /usr/share/doc/ntpsec-doc/html/accopt.html
# for details.
#
# Note that "restrict" applies to both servers and clients, so a configuration
# that might be intended to block requests from certain clients could also end
# up blocking replies from your own upstream servers.

# By default, exchange time with everybody, but don't allow configuration.
restrict 10.11.49.49 mask 255.255.255.255 noquery
restrict default kod nomodify noquery limited
restrict 127.0.0.1
restrict ::1

```
Ahora mismo este fichero actúa como cliente. Modificar las líneas comentadas para que actúa como server. Para comprobar que funciona:

ntpdate
```
2023-11-12 23:00:08.31313 (+0100) -0.000016 +/- 0.000085 localhost ::1 s12 no-leap
```

ntpstat
```
synchronised to unspecified at stratum 12
   time correct to within 21 ms
   polling server every 64 s
```

ntpq -p
```
     remote           refid      st t when poll reach   delay   offset   jitter
===============================================================================
*10.11.49.49     127.127.1.1     11 u   40   64  377   0.4301  -3.8650   3.1903

```

ntpq -p
```
2023-11-12T23:01:25 ntpd[985]: INIT: ntpd ntpsec-1.2.2: Starting
2023-11-12T23:01:25 ntpd[985]: INIT: Command line: ntpd -q
2023-11-12T23:01:25 ntpd[985]: INIT: precision = 0.101 usec (-23)
2023-11-12T23:01:25 ntpd[985]: INIT: successfully locked into RAM
2023-11-12T23:01:25 ntpd[985]: CONFIG: readconfig: parsing file: /etc/ntpsec/ntp                                                                                  .conf
2023-11-12T23:01:25 ntpd[985]: CLOCK: leapsecond file ('/usr/share/zoneinfo/leap                                                                                  -seconds.list'): good hash signature
2023-11-12T23:01:25 ntpd[985]: CLOCK: leapsecond file ('/usr/share/zoneinfo/leap                                                                                  -seconds.list'): loaded, expire=2023-12-28T00:00Z last=2017-01-01T00:00Z ofs=37
2023-11-12T23:01:25 ntpd[985]: IO: unable to bind to wildcard address :: - anoth                                                                                  er process may be running: Address already in use; EXITING
```

### b) Cruzando los dos equipos anteriores, configure con rsyslog un servidor y un cliente de logs. 
nano /etc/rsyslog.conf
```
# /etc/rsyslog.conf configuration file for rsyslog
#
# For more information install rsyslog-doc and see
# /usr/share/doc/rsyslog-doc/html/configuration/index.html


#################
#### MODULES ####
#################

module(load="imuxsock") # provides support for local system logging
module(load="imklog")   # provides kernel logging support
#module(load="immark")  # provides --MARK-- message capability

# provides UDP syslog reception
#module(load="imudp")
#input(type="imudp" port="514")

# provides TCP syslog reception
module(load="imtcp")
input(type="imtcp" port="514")


###########################
#### GLOBAL DIRECTIVES ####
###########################

#Para que le lleguen los logs del compañero
$AllowedSender TCP 127.0.0.1, 10.11.49.49

#
# Set the default permissions for all log files.
#
$FileOwner root
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022

#
# Where to place spool and state files
#
$WorkDirectory /var/spool/rsyslog

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf


###############
#### RULES ####
###############

#
# Log anything besides private authentication messages to a single log file
#
*.*;auth,authpriv.none          -/var/log/mis_logs.log

#
# Log commonly used facilities to their own log file
#
auth,authpriv.*                 /var/log/auth.log
cron.*                          -/var/log/cron.log
kern.*                          -/var/log/kern.log
mail.*                          -/var/log/mail.log
user.*                          -/var/log/user.log

#
# Emergencies are sent to everybody logged in.
#
*.emerg                         :omusrmsg:*

#Tamaño cola
$ActionQueueMaxDiskSpace 2g

#Servidor guarda los logs
$template remote, "/var/log/rsyslog-server/%fromhost-ip%/%programname%.log"
*.*?remote
& stop

#*.*action(
#       type="omfwd"
#       target="10.11.49.49"
#       port="514"
#       protocol="tcp"
#       action.resumeRetryCount="-1"
#       queue.type="linkedlist"
#       queue.filename="/var/log/rsyslog-queue"
#       queue.saveOnShutdown="on"
#)
```

Ahora mismo este fichero actúa como server. Para comprobar que funciona:
Cliente-> logger "hola"
Server-> cat /var/log/rsyslog-server/10.11.49.49/lsi.log

Para comprobar la cola hacer lo mismo pero con el server desconectado.
### c) Haga todo tipo de propuestas sobre los siguientes aspectos: ¿Qué problemas de seguridad identifica en los dos apartados anteriores?¿Cómo podría solucionar los problemas identificados? 
El principal problema de seguridad es la conectividad UDP. Para solucionarlo se deben hacer los dos protocolos por TCP y añadirlos a los wrappers.

### d) En la plataforma de virtualización corren, entre otros equipos, más de 200 máquinas virtuales para LSI. Como los recursos son limitados, y el disco duro también, identifique todas aquellas acciones que pueda hacer para reducir el espacio de disco ocupado. 
apt remove --purge 'gnome*'
apt remove --purge plymouth
apt remove --purge pulseaudio
apt remove --purge pipewire
apt remove --purge wireplumber
apt remove --purge 'libreoffice*'
apt remove --purge 'firefox*'
apt remove --purge 'firefox*'
apt remove --purge 'manpages*'
apt remove --purge caribou
apt remove --purge 'cups*'

apt autoremove
apt clean

### e) Instale el SIEM splunk en su máquina.
##### Ver los logs internos de splunk
index=\_internal

##### Geolocalizar IPs públicas
1. Modificar /var/log/auth.log y cambiar alguna IP privada por pública
2. /opt/splunk/bin/splunk start y abrir splunk en el navegador
3. Añadir un field IP
4.  Mapear con:
```
source="/var/log/auth.log" IP=* 
| iplocation IP 
| stats count by Country 
| geom geo_countries allFeatures=True featureIdField=Country
```
