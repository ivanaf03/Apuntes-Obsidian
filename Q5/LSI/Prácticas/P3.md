[[Lexislación e Seguridade Informática]]

### 1. Tomando como base de trabajo el SSH pruebe sus diversas utilidades.
##### a. Abra un shell remoto sobre SSH y analice el proceso que se realiza. Configure su fichero ssh_known_hosts para dar soporte a la clave pública del servidor.
+ cd /etc/ssh/
+ touch ssh_known_hosts
+ ssh-keyscan 10.11.49.56 >> ssh_known_hosts
+ cat ssh_known_hosts
```
10.11.49.56 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDOoYF0JJyIT4ay9oqlJiuAPn5g854HOHuzo8deFN8m1Yv6Xf+6/AlCQ3OdmcvTObAAtSPcVEzywH8KNz8GqkxkxFQ532IknQqxcSlECvxy1I1DozueB9rfnlhdRT58dI0I/ENTqnnyiZoz0+icbTH7ArmB/oarEaPqqEipnfW/KXILE6ZbLPtY05gyJeeHxBXJqsXJHQ6Q4b3YORHU6D/XHzxfqYhnpPAh6kBXbXSiQ4TdgUbPSvVKej/FUhGpbyB6PJrngd40nIzKpE5vC1gQtpLl010jA9l5gFoQOjqfrLo7503V3yel8nHl9cNd77W8bIR+zEsuZz+TONWlqWAl
10.11.49.56 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI8TcF8KSmeqWAaiSQL6md22snlQdCXIdb4PVK7Z+H0QShuFSthOTY239HxE6ywXadhita31CFmKDtWsWDJnSz8=
10.11.49.56 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJxcz7u3Ku4BMMTSqbnOg28qedeXle9onc47+SrZZUiR

```

##### b. Haga una copia remota de un fichero utilizando un algoritmo de cifrado determinado. Analice el proceso que se realiza.
+ cat /etc/ssh/ssh_config | grep Ciphers
```
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc
```
+ scp -c aes128-ctr hola.txt lsi@10.11.49.49:/home/lsi

##### c. Configure su cliente y servidor para permitir conexiones basadas en un esquema de autenticación de usuario de clave pública. 
Cliente:
+ ssh-keygen -t rsa -b 4096
```
Generating public/private rsa key pair.
Enter file in which to save the key (/home/lsi/.ssh/id_rsa): /home/lsi/.ssh/id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Passphrases do not match.  Try again.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/lsi/.ssh/id_rsa
Your public key has been saved in /home/lsi/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:BOQdASlxFzMFtl/Q49giLtdHVryGK5FMt30JKJRBhyA lsi@ivan32
The key's randomart image is:
+---[RSA 4096]----+
|    .E=+&O*o..   |
|    .oo= Ooo+.o  |
|     .. +o.*.*...|
|       ...*.B +..|
|       .So.= o . |
|      . o o o    |
|       o   o     |
|                 |
|                 |
+----[SHA256]-----+
```
+ ssh-copy-id lsi@10.11.49.49
+  cat /home/lsi/.ssh/authorized_keys
```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCCtAylhjdA+l64wsXIbyI7mb1kEF19W8VnFfsFMJUuI9NOxjGhQoStM4bfERXNpVRoZNuUJqBKYun3JNEUAmmi+TlQRrc0CcLBeGDaCTGyuYhueJOt1iURGnLQ84/DtjyyMnrhv0+96f1cE23vPSKuQ2b9FGJJofm2UeWkpdVrZBch2baCFDOlqINrVJhyy7DYe/5jfjC4ilexZu/GBbAMPPK2XYy9NmqCaetmzZB9OO/bx6LLsZzAAoM8PoyfRuzx5wOgjynyTMttp+4sE88fVxlfmuHvl5AON2iRYT8D7+kFTOS7tJKRy+ZO0kBttVp+YDO2hcUZeko4U1Oy4Arey1/QjGcPSPBPa4q2ILSwAQeOwMn1pYJSeyS2sA0sJ2+YcnqWBxRrcxFEvd3mEK6M63QFwRcJMQBzyj4F50d4BOZpuOC7xl5nY0Ccsmqr8xgGOwU3LSpMIPaGC0WVLDNUVzbBvm9eyW2t4iKG9l7jVoQ6nMAxzapXSN7qSo+ZPRE= lsi@ivanna32
```

##### d. Mediante túneles SSH securice algún servicio no seguro. 
+ ssh -L 8080:10.11.49.49:80 lsi@10.11.49.49
+ ssh -L 10.11.49.56:8080:10.11.49.49:80 lsi@10.11.49.49

Mientras está la conexión ssh tunelizada, si entro desde google 10.11.49.56:8080 me saldría el servidor del puerto 80 de mi compañera.

##### e. “Exporte” un directorio y “móntelo” de forma remota sobre un túnel SSH.
+ COMO LSI: mkdir dropbox
+ COMO LSI: sshfs lsi@10.11.49.49:/home/lsi/dropbox /home/lsi/dropbox

##### f. PARA PLANTEAR DE FORMA TEÓRICA: Securice su servidor considerando que únicamente dará servicio ssh para sesiones de usuario desde determinadas IPs.
+ nano /etc/ssh/sshd_config
+ ListenAddress 10.11.49.49
+ AllowUsers lsi@10.11.49.49

Opcional:
+ PasswordAuthentication no

### 2. Tomando como base de trabajo el servidor Apache2 

##### a. Configure una Autoridad Certificadora en su equipo. 
+ cd /usr/lib/ssl/misc/
+ ./CA.pl -newca
```
CA certificate filename (or enter to create)

Making CA certificate ...
====
openssl req  -new -keyout ./demoCA/private/cakey.pem -out ./demoCA/careq.pem
...+.....+......+.......+...+..+.+..+.......+.....+.+.....+....+...+.....+...+.+                                                                                ...+...+..............+.+........+.+......+..................+..+............+.+                                                                                ......+.....+....+.....................+...+..+.+........+.......+...+.....+....                                                                                ...........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...                                                                                .....+.......+...........+.......+........+...+....+...+.....+.......+++++++++++                                                                                ++++++++++++++++++++++++++++++++++++++++++++++++++++++*............+....+......+                                                                                .....+....+.....+................+...+.....+.......+........+.+.....+....+.....+                                                                                ..........+.........+...............................................+......+....                                                                                ........+..........+...+...+..+..........+..+...+.......+.....+.+..+............                                                                                ...+..........+.........+.........+.........+.....+..................+...+......                                                                                .+............+..+...+...+....+.........+.........+..+.........+.+...........+..                                                                                .+.+......+..................+..+.......+......+..+....+.........+..+...+....+..                                                                                .+..+......+.+...+..+....+...........+...+...+.........+.+..+......+.+..........                                                                                .+...+....+...+...+......+........+......+....+...+.....+...+.........+.......++                                                                                +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
..+................+...+...+.....+.......+........++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++++++++++++++++++*.....+..+...+...+..................+.+......                                                                                ........+.+........+.+.....+.+......+...+............+.....+..........+...+.....                                                                                ......+.+.................+.+.....++++++++++++++++++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++*...+..+.........+.+..............+....+......+........+.....                                                                                ..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:A Coruna
Locality Name (eg, city) []:A Coruna
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UDC
Organizational Unit Name (eg, section) []:FIC
Common Name (e.g. server FQDN or YOUR name) []:ivan
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
==> 0
====
====
openssl ca  -create_serial -out ./demoCA/cacert.pem -days 1095 -batch -keyfile .                                                                                /demoCA/private/cakey.pem -selfsign -extensions v3_ca -infiles ./demoCA/careq.pe                                                                                m
Using configuration from /usr/lib/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            4c:75:8e:61:ee:d2:eb:69:81:67:c2:8c:84:34:3c:5d:37:5f:85:fa
        Validity
            Not Before: Nov 28 16:46:49 2023 GMT
            Not After : Nov 27 16:46:49 2026 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = A Coruna
            organizationName          = UDC
            organizationalUnitName    = FIC
            commonName                = ivan
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
            X509v3 Authority Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
            X509v3 Basic Constraints: critical
                CA:TRUE
Certificate is to be certified until Nov 27 16:46:49 2026 GMT (1095 days)

Write out database with 1 new entries
Database updated
==> 0
====
```
##### b. Cree su propio certificado para ser firmado por la Autoridad Certificadora. Bueno, y fírmelo. 
+ ./CA.pl -newreq-nodes
```
====
openssl req  -new -nodes -keyout newkey.pem -out newreq.pem -days 365
Ignoring -days without -x509; not generating a certificate
..+....+...+........+...+.+...+..+.............+...+.....+....+...........+...++                                                                                +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+.......+....                                                                                .+.+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+...+                                                                                ....................+.......+...+........+.+..............+....+..+...+.+..+....                                                                                +...+.....+.......+......+...+.....+.+........+.+......+.....+.+........+.+...+.                                                                                ..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
.+..+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*......                                                                                ........+....+..+....+...+...+........++++++++++++++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++++++*.......+..+.......+...........+.........+.+...........+.                                                                                +...+.....+.+.............................+....+...........+......+.............                                                                                +..+....+.........+......+.....+......+.+.........+......+...+..+....+..........                                                                                ....+.+.....+.........+....+..+.+...+..+.........+.........+....+...+..+.+..+...                                                                                +.+...+.....+.+............+.....+...+......+...............+.+........+.......+                                                                                ..+.......+...........+..........+........+....+.....+............+.+..+........                                                                                .......+...+..........+.....+...+......+...+.......+...+......+.....+....+......                                                                                ..+...+................+........+......+.........+...+.......+...+...+..+.......                                                                                +........+....+........+.+..+...............+.......+......+......+.....+.+.....                                                                                ...+.+.....+......+...+.+...+...........+....+...+..+............+...+......+...                                                                                ....+.....+.........+.+........+.+.....+..........+...............+...+...+.....                                                                                ............+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:A Coruna
Locality Name (eg, city) []:A Coruna
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UDC
Organizational Unit Name (eg, section) []:FIC
Common Name (e.g. server FQDN or YOUR name) []:ivan
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
==> 0
====
Request is in newreq.pem, private key is in newkey.pem
```
+ IVANNA FIRMA: ./CA.pl -sign
```
====
openssl ca  -policy policy_anything -out newcert.pem -infiles newreq.pem
Using configuration from /usr/lib/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            4c:75:8e:61:ee:d2:eb:69:81:67:c2:8c:84:34:3c:5d:37:5f:85:fb
        Validity
            Not Before: Nov 28 16:54:31 2023 GMT
            Not After : Nov 27 16:54:31 2024 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = A Coruna
            localityName              = A Coruna
            organizationName          = UDC
            organizationalUnitName    = FIC
            commonName                = ivan
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Subject Key Identifier:
                83:8E:4C:5A:EC:62:A1:A5:FE:EF:43:D6:64:C7:64:26:A4:AB:00:56
            X509v3 Authority Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
Certificate is to be certified until Nov 27 16:54:31 2024 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Database updated
==> 0
====
Signed certificate is in newcert.pem
```
##### c. Configure su Apache para que únicamente proporcione acceso a un determinado directorio del árbol web bajo la condición del uso de SSL. Considere que si su la clave privada está cifrada en el proceso de arranque su máquina le solicitará la correspondiente frase de paso, pudiendo dejarla inalcanzable para su sesión ssh de trabajo.
+ a2enmod ssl
+ cp newkey.pem newcert.pem demoCA/cacert.pem /etc/apache2/ssl
+ cat /etc/apache2/sites-available/000-default.conf
```
<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port th                                                                                at
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        <Directory /var/www/html/privada>
                Require all denied
        </Directory>

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf

        #SecRuleEngine On
        #SecRule ARGS:testparam "@contains test" "id:254,deny,status:403,msg:'Te                                                                                st Successful'"
</VirtualHost>
```

+ cat /etc/apache2/sites-available/default-ssl.conf 
```
<VirtualHost *:443>
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf

        #   SSL Engine Switch:
        #   Enable/Disable SSL for this virtual host.
        SSLEngine on

        #   A self-signed (snakeoil) certificate can be created by installing
        #   the ssl-cert package. See
        #   /usr/share/doc/apache2/README.Debian.gz for more info.
        #   If both key and certificate are stored in the same file, only the
        #   SSLCertificateFile directive is needed.
        SSLCertificateFile      /etc/apache2/ssl/newcert.pem
        SSLCertificateKeyFile   /etc/apache2/ssl/newkey.pem
        SSLCACertificateFile    /etc/apache2/ssl/cacert.pem

        #   Server Certificate Chain:
        #   Point SSLCertificateChainFile at a file containing the
        #   concatenation of PEM encoded CA certificates which form the
        #   certificate chain for the server certificate. Alternatively
        #   the referenced file can be the same as SSLCertificateFile
        #   when the CA certificates are directly appended to the server
        #   certificate for convinience.
        #SSLCertificateChainFile /etc/apache2/ssl.crt/server-ca.crt

        #   Certificate Authority (CA):
        #   Set the CA certificate verification path where to find CA
        #   certificates for client authentication or alternatively one
        #   huge file containing all of them (file must be PEM encoded)
        #   Note: Inside SSLCACertificatePath you need hash symlinks
        #         to point to the certificate files. Use the provided
        #         Makefile to update the hash symlinks after changes.
        #SSLCACertificatePath /etc/ssl/certs/
        #SSLCACertificateFile /etc/apache2/ssl.crt/ca-bundle.crt

        #   Certificate Revocation Lists (CRL):
        #   Set the CA revocation path where to find CA CRLs for client
        #   authentication or alternatively one huge file containing all
        #   of them (file must be PEM encoded)
        #   Note: Inside SSLCARevocationPath you need hash symlinks
        #         to point to the certificate files. Use the provided
        #         Makefile to update the hash symlinks after changes.
        #SSLCARevocationPath /etc/apache2/ssl.crl/
        #SSLCARevocationFile /etc/apache2/ssl.crl/ca-bundle.crl

        #   Client Authentication (Type):
        #   Client certificate verification type and depth.  Types are
        #   none, optional, require and optional_no_ca.  Depth is a
        #   number which specifies how deeply to verify the certificate
        #   issuer chain before deciding the certificate is not valid.
        #SSLVerifyClient require
        #SSLVerifyDepth  10

        #   SSL Engine Options:
        #   Set various options for the SSL engine.
        #   o FakeBasicAuth:
        #    Translate the client X.509 into a Basic Authorisation.  This means                                                                                 that
        #    the standard Auth/DBMAuth methods can be used for access control.                                                                                  The
        #    user name is the `one line' version of the client's X.509 certifica                                                                                te.
        #    Note that no password is obtained from the user. Every entry in the                                                                                 user
        #    file needs this password: `xxj31ZMTZzkVA'.
        #   o ExportCertData:
        #    This exports two additional environment variables: SSL_CLIENT_CERT                                                                                 and
        #    SSL_SERVER_CERT. These contain the PEM-encoded certificates of the
        #    server (always existing) and the client (only existing when client
        #    authentication is used). This can be used to import the certificate                                                                                s
        #    into CGI scripts.
        #   o StdEnvVars:
        #    This exports the standard SSL/TLS related `SSL_*' environment varia                                                                                bles.
        #    Per default this exportation is switched off for performance reason                                                                                s,
        #    because the extraction step is an expensive operation and is usuall                                                                                y
        #    useless for serving static content. So one usually enables the
        #    exportation for CGI and SSI requests only.
        #   o OptRenegotiate:
        #    This enables optimized SSL connection renegotiation handling when S                                                                                SL
        #    directives are used in per-directory context.
        #SSLOptions +FakeBasicAuth +ExportCertData +StrictRequire
        <FilesMatch "\.(?:cgi|shtml|phtml|php)$">
                SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                SSLOptions +StdEnvVars
        </Directory>

        #   SSL Protocol Adjustments:
        #   The safe and default but still SSL/TLS standard compliant shutdown
        #   approach is that mod_ssl sends the close notify alert but doesn't wa                                                                                it for
        #   the close notify alert from client. When you need a different shutdo                                                                                wn
        #   approach you can use one of the following variables:
        #   o ssl-unclean-shutdown:
        #    This forces an unclean shutdown when the connection is closed, i.e.                                                                                 no
        #    SSL close notify alert is send or allowed to received.  This violat                                                                                es
        #    the SSL/TLS standard but is needed for some brain-dead browsers. Us                                                                                e
        #    this when you receive I/O errors because of the standard approach w                                                                                here
        #    mod_ssl sends the close notify alert.
        #   o ssl-accurate-shutdown:
        #    This forces an accurate shutdown when the connection is closed, i.e                                                                                . a
        #    SSL close notify alert is send and mod_ssl waits for the close noti                                                                                fy
        #    alert of the client. This is 100% SSL/TLS standard compliant, but i                                                                                n
        #    practice often causes hanging connections with brain-dead browsers.                                                                                 Use
        #    this only for browsers where you know that their SSL implementation
        #    works correctly.
        #   Notice: Most problems of broken clients are also related to the HTTP
        #   keep-alive facility, so you usually additionally want to disable
        #   keep-alive for those clients, too. Use variable "nokeepalive" for th                                                                                is.
        #   Similarly, one has to force some clients to use HTTP/1.0 to workarou                                                                                nd
        #   their broken HTTP/1.1 implementation. Use variables "downgrade-1.0"                                                                                 and
        #   "force-response-1.0" for this.
        # BrowserMatch "MSIE [2-6]" \
        #       nokeepalive ssl-unclean-shutdown \
        #       downgrade-1.0 force-response-1.0

</VirtualHost>
```

+ cp cacert.pem /usr/local/share/ca-certificates/ca.crt
+ update-ca-certificates     
+ lynx https://ivan/privada
+ openssl s_client -connect 10.11.49.56:443 -showcerts
```
CONNECTED(00000003)
Can't use SSL_get_servername
depth=1 C = ES, ST = Coruna, O = UDC, OU = FIC, CN = chuten
verify return:1
depth=0 C = ES, ST = A Coruna, L = A Coruna, O = UDC, OU = FIC, CN = ivan
verify return:1
---
Certificate chain
 0 s:C = ES, ST = A Coruna, L = A Coruna, O = UDC, OU = FIC, CN = ivan
   i:C = ES, ST = Coruna, O = UDC, OU = FIC, CN = chuten
   a:PKEY: rsaEncryption, 2048 (bit); sigalg: RSA-SHA256
   v:NotBefore: Dec  5 12:25:37 2023 GMT; NotAfter: Dec  4 12:25:37 2024 GMT
-----BEGIN CERTIFICATE-----
MIIDhDCCAmygAwIBAgIUPKwZQUrjQM+uzVM3YoYV/iboRswwDQYJKoZIhvcNAQEL
BQAwSzELMAkGA1UEBhMCRVMxDzANBgNVBAgMBkNvcnVuYTEMMAoGA1UECgwDVURD
MQwwCgYDVQQLDANGSUMxDzANBgNVBAMMBmNodXRlbjAeFw0yMzEyMDUxMjI1Mzda
Fw0yNDEyMDQxMjI1MzdaMF4xCzAJBgNVBAYTAkVTMREwDwYDVQQIDAhBIENvcnVu
YTERMA8GA1UEBwwIQSBDb3J1bmExDDAKBgNVBAoMA1VEQzEMMAoGA1UECwwDRklD
MQ0wCwYDVQQDDARpdmFuMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
zXdXRq7sthkTkQBDh+2YsfegsMEinft7NDAybf5u8jziRwY6xPhG9S76BvJAceoT
vcbWNUmKYKc9CV08AhVgYLD7RxUoqPGBz8gRQiGz6EY1tMw25RQEdBlZR81n5nYC
we2k1zz5QWJXkvv2GutfC7nEo4eR87Z3RYmtRbDkUDMWxxq742A4KDmRibdb0S5F
cVD6reTqtJp0Bm0o7nOUmN3Nuvc3MdtgQu6/aP/Rloj4wTPpZXbRKk+JIrBJO9ZL
8Fq9lnqc5s//yIckkrFUJL1zHDz8Ry2T4UM8NMGO1O9GM3w238rb7wg5/3INlHxq
DrB9FF9PS2sgyO98H/UQwwIDAQABo00wSzAJBgNVHRMEAjAAMB0GA1UdDgQWBBTf
GQK7CqAMgSPQwg90uPase7BxJzAfBgNVHSMEGDAWgBR/i/Q34/Quh4yUQEx5P4As
ibGOfTANBgkqhkiG9w0BAQsFAAOCAQEAM4HS0LPRFO46Jrf5C0CD1irUi/iwBUpB
0Ehsy3OGERhnizccb0of2qJ2+nX/2koTeOlmOa2Xwj8P8isJTPKOhjFMOYWhAFpv
MNrfY6OKYY0KTQBwoCJgAYLVhhsxp4dF7mEimgztKOhtsgImQn38UrRiiD97xNsQ
wBX9kEYNieRSLIdO6dA+kufi1kyXSfTKgbCvHTlBEo3SgroNCfC3CNVAafD0PKYh
IGDZtfcisnhUJJtD9TXDwB/2nJcWjSx4U0eBojxFO6T+Rst0o+sAyGBlz3Fg7X5a
a4/GhM/5b4/C+p0lM+CujivZdSYKxrRNHBukySxo7nwNAjwP6pCTYA==
-----END CERTIFICATE-----
 1 s:C = ES, ST = Coruna, O = UDC, OU = FIC, CN = chuten
   i:C = ES, ST = Coruna, O = UDC, OU = FIC, CN = chuten
   a:PKEY: rsaEncryption, 2048 (bit); sigalg: RSA-SHA256
   v:NotBefore: Dec  5 12:09:07 2023 GMT; NotAfter: Dec  4 12:09:07 2026 GMT
-----BEGIN CERTIFICATE-----
MIIDdzCCAl+gAwIBAgIUPKwZQUrjQM+uzVM3YoYV/iboRsswDQYJKoZIhvcNAQEL
BQAwSzELMAkGA1UEBhMCRVMxDzANBgNVBAgMBkNvcnVuYTEMMAoGA1UECgwDVURD
MQwwCgYDVQQLDANGSUMxDzANBgNVBAMMBmNodXRlbjAeFw0yMzEyMDUxMjA5MDda
Fw0yNjEyMDQxMjA5MDdaMEsxCzAJBgNVBAYTAkVTMQ8wDQYDVQQIDAZDb3J1bmEx
DDAKBgNVBAoMA1VEQzEMMAoGA1UECwwDRklDMQ8wDQYDVQQDDAZjaHV0ZW4wggEi
MA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCdoTUZTxFsGsm/HaoVksDpGwOp
YKlObf+Q/wE3O6MpbkyUPfVOQf3xa/gVRToX5hW5YIwxtlFA8+A+bebOk9uoo6zh
8+9+D2Y/QPO3aM+H8OH86UVTQCyBmh7KDeM7VuHYzR4p41NgH/olBKvzAEpc4sZ8
IVk+YSLz0ou9ozwwvAR15zG5JVIw92Y1/q22fTXyDfseo24EdcSZ0gzf1OU6dwid
eXH1ezvRV0CwwDQCz5vPIxH2Yu+D4/v6Tx9yVkV8BYm83z3858a2v4Bh3hih2Ocl
5/k7eh+wlD7CwU3Tyl0TjATrMLKsz/kk6QtLhk1byGwbNXln/wGGchFX7PSFAgMB
AAGjUzBRMB0GA1UdDgQWBBR/i/Q34/Quh4yUQEx5P4AsibGOfTAfBgNVHSMEGDAW
gBR/i/Q34/Quh4yUQEx5P4AsibGOfTAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3
DQEBCwUAA4IBAQBhnmRZnkzNdU+iJ3S0JzseUUnny/tTqCND6kQFEDChii8U5g+L
3BISt6Bqmw0c3ElwGAq376TUJJRacY/p495wXqsQxNY0/uZJF/IbbPLUXnsLrSAg
w19qefBh4+BsdbVXlNzTvlsn1N9SKMgLTkdylC+ndOWkMirDmj2o+cg5cU1Az8Sy
s9r4NmFaZct86SiNs7wq9iI5lSi/IloN1yrby7ClkPaO4i0k3V/Y7tZYmcKjQga+
lWyGh1ckJt56cqNqT3cQMrPGF0v/UL17itMOpIISmzffk5Z5cfERHBGHGLw7JHmD
xce3TDCU/NE9dnLIWmKhxryb6tAhCi99iIPO
-----END CERTIFICATE-----
---
Server certificate
subject=C = ES, ST = A Coruna, L = A Coruna, O = UDC, OU = FIC, CN = ivan
issuer=C = ES, ST = Coruna, O = UDC, OU = FIC, CN = chuten
---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA-PSS
Server Temp Key: X25519, 253 bits
---
SSL handshake has read 2356 bytes and written 377 bytes
Verification: OK
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 7E9327E4519C107C531F6D528E35CF0731E55AD3C25920BBF8A5BD46D1F8C88D
    Session-ID-ctx:
    Resumption PSK: DC122C0DAC27DEB90319AB60F784A6E546E89795F0B1EAC582E3EC405C9E                                                                                B0695F39F52AC58E26029E70189A814287E0
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - d9 e9 30 60 5f e3 e4 6f-af 30 0a ad 38 37 7c ad   ..0`_..o.0..87|.
    0010 - ba 78 77 80 ae 01 40 98-7f b1 8c 2f 8a 80 f6 1c   .xw...@..../....

    Start Time: 1701903756
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 70785837FD38788EF7410AEF14BC22CA59000781BE8C58A107B5D8E2D984A5B6
    Session-ID-ctx:
    Resumption PSK: E062482D79E0D5AA6167A344973991B796D88B91ACF2CFB1F11135F3004E                                                                                E65BE2CB054F1B135E2975A1AE879D13D5C8
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - 22 33 32 be d8 44 5e c2-e3 47 aa 7a fe 1a a7 88   "32..D^..G.z....
    0010 - 8e dd a6 b5 ea a2 e8 ed-a8 59 e9 f5 5b fc 33 0b   .........Y..[.3.

    Start Time: 1701903756
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
```

### 3.Tomando como base de trabajo el openVPN deberá configurar una VPN entre dos equipos virtuales del laboratorio que garanticen la confidencialidad entre sus comunicaciones.
+ cd /etc/openvpn
+ openvpn --genkey secret static.key
+ cat tun0.conf
```
remote 10.11.49.49
dev tun0
ifconfig 10.9.8.2 10.9.8.1
cipher AES-256-CBC
port 2020
secret /etc/openvpn/static.key

#ivanna
dev tun0
ifconfig 10.9.8.1 10.9.8.2
cipher AES-256-CBC
port 2020
secret /etc/openvpn/static.key
```
+ openvpn --config /etc/openvpn/tun0.conf --verb 6
+ service openvpn stop

### 6. En este punto, cada máquina virtual será servidor y cliente de diversos servicios (NTP, syslog, ssh, web, etc.). Configure un “firewall stateful” de máquina adecuado a la situación actual de su máquina.
+ cat firewall
```
iptables -F
iptables -X
ip6tables -F
ip6tables -X


iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
ip6tables -P INPUT DROP
ip6tables -P FORWARD DROP
ip6tables -P OUTPUT DROP


iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT
ip6tables -A INPUT -i lo -j ACCEPT
ip6tables -A OUTPUT -o lo -j ACCEPT


iptables -A INPUT -i 6to4 -j ACCEPT
iptables -A OUTPUT -o 6to4 -j ACCEPT


iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
ip6tables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
ip6tables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT


iptables -A INPUT -p ipv6 -s 10.11.49.56 -j ACCEPT
iptables -A OUTPUT -p ipv6 -d  10.11.49.49  -j ACCEPT
iptables -A OUTPUT -p ipv6 -d  10.11.49.44  -j ACCEPT


iptables -A INPUT -p ICMP -s 10.11.49.49 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p ICMP -s 10.11.51.49 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p ICMP -s 10.11.49.44 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p ICMP -s 10.11.51.44 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p ICMP -s 10.9.8.1 -m conntrack --ctstate NEW -j ACCEPT
iptables -A INPUT -p ICMP -s 10.9.8.2 -m conntrack --ctstate NEW -j ACCEPT
iptables -A OUTPUT -p ICMP -m conntrack --ctstate NEW -j ACCEPT


iptables -A INPUT -p TCP --dport 22 -s 10.11.49.49 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.11.51.49 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.11.49.44 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.11.51.44 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.9.8.1 -m conntrack --ctstate NEW -j AC                                                                                CEPT
iptables -A INPUT -p TCP --dport 22 -s 10.9.8.2 -m conntrack --ctstate NEW -j AC                                                                                CEPT
iptables -A INPUT -p TCP --dport 8080 -s 10.11.49.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p TCP --dport 8080 -s 10.11.49.44 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p TCP --dport 80 -s 10.11.49.49 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 80 -s 10.11.49.44 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.30.8.0/255.255.248.0 -m conntrack --ct                                                                                state NEW -j ACCEPT
iptables -A INPUT -p TCP --dport 22 -s 10.20.32.0/255.255.248.0 -m conntrack --c                                                                                tstate NEW -j ACCEPT
iptables -A OUTPUT -p TCP --dport 22 -m conntrack --ctstate NEW -j ACCEPT
ip6tables -A INPUT -p TCP --dport 22 -s 2002:0a0b:3131:: -m conntrack --ctstate                                                                                 NEW -j ACCEPT
ip6tables -A OUTPUT -p TCP --dport 22 -d 2002:0a0b:3131:: -m conntrack --ctstate                                                                                 NEW -j ACCEPT
ip6tables -A INPUT -p TCP --dport 22 -s 2002:0a0b:312c::1 -m conntrack --ctstate                                                                                 NEW -j ACCEPT
ip6tables -A OUTPUT -p TCP --dport 22 -d 2002:0a0b:312c::1 -m conntrack --ctstat                                                                                e NEW -j ACCEPT


iptables -A INPUT -p UDP --dport 123 -s 10.11.49.49 -m conntrack --ctstate NEW -                                                                                j ACCEPT
iptables -A OUTPUT -p UDP --sport 123 -d 10.11.49.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p UDP --dport 123 -s 10.11.49.44 -m conntrack --ctstate NEW -                                                                                j ACCEPT
iptables -A OUTPUT -p UDP --sport 123 -d 10.11.49.44 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p UDP --dport 123 -s 10.9.8.1 -m conntrack --ctstate NEW -j A                                                                                CCEPT
iptables -A OUTPUT -p UDP --sport 123 -d 10.9.8.1 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p UDP --dport 123 -s 10.9.8.2 -m conntrack --ctstate NEW -j A                                                                                CCEPT
iptables -A OUTPUT -p UDP --sport 123 -d 10.9.8.2 -m conntrack --ctstate NEW -j                                                                                 ACCEPT


iptables -A INPUT -p TCP --dport 514 -s 10.11.49.49 -m conntrack --ctstate NEW -                                                                                j ACCEPT
iptables -A OUTPUT -p TCP --dport 514 -d 10.11.49.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p TCP --dport 514 -s 10.11.49.44 -m conntrack --ctstate NEW -                                                                                j ACCEPT
iptables -A OUTPUT -p TCP --dport 514 -d 10.11.49.44 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p TCP --dport 514 -s 10.9.8.2 -m conntrack --ctstate NEW -j A                                                                                CCEPT
iptables -A OUTPUT -p TCP --dport 514 -d 10.9.8.2 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A INPUT -p TCP --dport 514 -s 10.9.8.1 -m conntrack --ctstate NEW -j A                                                                                CCEPT
iptables -A OUTPUT -p TCP --dport 514 -d 10.9.8.1 -m conntrack --ctstate NEW -j                                                                                 ACCEPT


iptables -A OUTPUT -p UDP --dport 53 -d 10.8.12.49 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A OUTPUT -p UDP --dport 53 -d 10.8.12.47 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
iptables -A OUTPUT -p UDP --dport 53 -d 10.8.12.50 -m conntrack --ctstate NEW -j                                                                                 ACCEPT


ip6tables -A INPUT -p icmpv6 -s 2002:0a0b:3131:: -m conntrack --ctstate NEW -j A                                                                                CCEPT
ip6tables -A INPUT -p icmpv6 -s 2002:0a0b:312c::1 -m conntrack --ctstate NEW -j                                                                                 ACCEPT
ip6tables -A OUTPUT -p icmpv6 -m conntrack --ctstate NEW -j ACCEPT


iptables -A INPUT -p tcp --dport 25 -j DROP
iptables -A OUTPUT -p tcp --dport 25 -j DROP


iptables -A INPUT -p TCP -s 10.11.49.49 -m multiport --dport 80,443 -m conntrack                                                                                 --ctstate NEW -j ACCEPT
iptables -A INPUT -p TCP -s 10.11.49.44 -m multiport --dport 80,443 -m conntrack                                                                                 --ctstate NEW -j ACCEPT
iptables -A OUTPUT -p TCP -m multiport --dport 80,443 -m conntrack --ctstate NEW                                                                                 -j ACCEPT


iptables -A INPUT -p TCP  --dport 2020 -s 10.11.49.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A INPUT -p TCP  --dport 2020 -s 10.11.51.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A OUTPUT -p TCP --sport 2020 -d 10.11.49.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT
iptables -A OUTPUT -p TCP --sport 2020 -d 10.11.51.49 -m conntrack --ctstate NEW                                                                                 -j ACCEPT


iptables -A INPUT -i ens33 -s 10.11.49.49 -p udp -m conntrack --ctstate NEW --dp                                                                                ort 2020 -j ACCEPT
iptables -A OUTPUT -o ens33 -d 10.11.49.49 -p udp -m conntrack --ctstate NEW --d                                                                                port 2020 -j ACCEPT

sleep 2m
echo "GG"

iptables -F
iptables -X
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
ip6tables -F
ip6tables -X
ip6tables -P INPUT ACCEPT
ip6tables -P FORWARD ACCEPT
ip6tables -P OUTPUT ACCEPT
```

### 7. Ejecute la utilidad de auditoría de seguridad lynis en su sistema y trate de identificar las acciones de securización detectadas así como los consejos sobre las que se deberían contemplar.
+ wget https://downloads.cisofy.com/lynis/lynis-3.0.9.tar.gz 
+ tar xvf lynis-3.0.9.tar.gz
+ cd lynis
+ ./lynis audit system

Test and debug information:
+ cat /var/log/lynis.log

Report data:
+ cat /var/log/lynis-report.dat

Sugerencias: 
```
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowTcpForwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option AllowTcpForwarding;field:AllowTcpForwarding;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|ClientAliveCountMax (set 3 to 2)|-|
details[]=SSH-7408|sshd|desc:sshd option ClientAliveCountMax;field:ClientAliveCountMax;prefval:2;value:3;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|LogLevel (set INFO to VERBOSE)|-|
details[]=SSH-7408|sshd|desc:sshd option LogLevel;field:LogLevel;prefval:VERBOSE;value:INFO;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxAuthTries (set 6 to 3)|-|
details[]=SSH-7408|sshd|desc:sshd option MaxAuthTries;field:MaxAuthTries;prefval:3;value:6;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxSessions (set 10 to 2)|-|
details[]=SSH-7408|sshd|desc:sshd option MaxSessions;field:MaxSessions;prefval:2;value:10;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|Port (set 22 to )|-|
details[]=SSH-7408|sshd|desc:sshd option Port;field:Port;prefval:;value:22;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|TCPKeepAlive (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option TCPKeepAlive;field:TCPKeepAlive;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|X11Forwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option X11Forwarding;field:X11Forwarding;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowAgentForwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option AllowAgentForwarding;field:AllowAgentForwarding;prefval:NO;value:YES;|
```