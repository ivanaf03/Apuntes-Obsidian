[[Lexislación e Seguridade Informática]]

### 1. Tomando como base de trabajo el SSH pruebe sus diversas utilidades.
##### a. Abra un shell remoto sobre SSH y analice el proceso que se realiza. Configure su fichero ssh_known_hosts para dar soporte a la clave pública del servidor.
+ cd /etc/ssh/
+ touch ssh_known_hosts
+ ssh-keyscan 10.11.49.56 >> ssh_known_hosts
+ cat ssh_known_hosts
```
10.11.49.56 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDOoYF0JJyIT4ay9oqlJiuAPn5g854HOHuzo8deFN8m1Yv6Xf+6/AlCQ3OdmcvTObAAtSPcVEzywH8KNz8GqkxkxFQ532IknQqxcSlECvxy1I1DozueB9rfnlhdRT58dI0I/ENTqnnyiZoz0+icbTH7ArmB/oarEaPqqEipnfW/KXILE6ZbLPtY05gyJeeHxBXJqsXJHQ6Q4b3YORHU6D/XHzxfqYhnpPAh6kBXbXSiQ4TdgUbPSvVKej/FUhGpbyB6PJrngd40nIzKpE5vC1gQtpLl010jA9l5gFoQOjqfrLo7503V3yel8nHl9cNd77W8bIR+zEsuZz+TONWlqWAl
10.11.49.56 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBI8TcF8KSmeqWAaiSQL6md22snlQdCXIdb4PVK7Z+H0QShuFSthOTY239HxE6ywXadhita31CFmKDtWsWDJnSz8=
10.11.49.56 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJxcz7u3Ku4BMMTSqbnOg28qedeXle9onc47+SrZZUiR

```

##### b. Haga una copia remota de un fichero utilizando un algoritmo de cifrado determinado. Analice el proceso que se realiza.
+ cat /etc/ssh/ssh_config | grep Ciphers
```
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc
```
+ scp -c aes128-ctr hola.txt lsi@10.11.49.49:/home/lsi

##### c. Configure su cliente y servidor para permitir conexiones basadas en un esquema de autenticación de usuario de clave pública. 
Cliente:
+ ssh-keygen -t rsa -b 4096
```
Generating public/private rsa key pair.
Enter file in which to save the key (/home/lsi/.ssh/id_rsa): /home/lsi/.ssh/id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Passphrases do not match.  Try again.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/lsi/.ssh/id_rsa
Your public key has been saved in /home/lsi/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:BOQdASlxFzMFtl/Q49giLtdHVryGK5FMt30JKJRBhyA lsi@ivan32
The key's randomart image is:
+---[RSA 4096]----+
|    .E=+&O*o..   |
|    .oo= Ooo+.o  |
|     .. +o.*.*...|
|       ...*.B +..|
|       .So.= o . |
|      . o o o    |
|       o   o     |
|                 |
|                 |
+----[SHA256]-----+
```
+ ssh-copy-id lsi@10.11.49.49
+  cat /home/lsi/.ssh/authorized_keys
```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCCtAylhjdA+l64wsXIbyI7mb1kEF19W8VnFfsFMJUuI9NOxjGhQoStM4bfERXNpVRoZNuUJqBKYun3JNEUAmmi+TlQRrc0CcLBeGDaCTGyuYhueJOt1iURGnLQ84/DtjyyMnrhv0+96f1cE23vPSKuQ2b9FGJJofm2UeWkpdVrZBch2baCFDOlqINrVJhyy7DYe/5jfjC4ilexZu/GBbAMPPK2XYy9NmqCaetmzZB9OO/bx6LLsZzAAoM8PoyfRuzx5wOgjynyTMttp+4sE88fVxlfmuHvl5AON2iRYT8D7+kFTOS7tJKRy+ZO0kBttVp+YDO2hcUZeko4U1Oy4Arey1/QjGcPSPBPa4q2ILSwAQeOwMn1pYJSeyS2sA0sJ2+YcnqWBxRrcxFEvd3mEK6M63QFwRcJMQBzyj4F50d4BOZpuOC7xl5nY0Ccsmqr8xgGOwU3LSpMIPaGC0WVLDNUVzbBvm9eyW2t4iKG9l7jVoQ6nMAxzapXSN7qSo+ZPRE= lsi@ivanna32
```

##### d. Mediante túneles SSH securice algún servicio no seguro. 
+ ssh -L 8080:10.11.49.49:80 lsi@10.11.49.49
+ ssh -L 10.11.49.56:8080:10.11.49.49:80 lsi@10.11.49.49

Mientras está la conexión ssh tunelizada, si entro desde google 10.11.49.56:8080 me saldría el servidor del puerto 80 de mi compañera.

##### e. “Exporte” un directorio y “móntelo” de forma remota sobre un túnel SSH.
+ COMO LSI: mkdir dropbox
+ COMO ROOT: sshfs lsi@10.11.49.49:/home/lsi/dropbox /home/lsi/dropbox

##### f. PARA PLANTEAR DE FORMA TEÓRICA: Securice su servidor considerando que únicamente dará servicio ssh para sesiones de usuario desde determinadas IPs.
+ nano /etc/ssh/sshd_config
+ ListenAddress 10.11.49.49
+ AllowUsers lsi@10.11.49.49

Opcional:
+ PasswordAuthentication no

### 2. Tomando como base de trabajo el servidor Apache2 

##### a. Configure una Autoridad Certificadora en su equipo. 
+ cd /usr/lib/ssl/misc/
+ ./CA.pl -newca
```
CA certificate filename (or enter to create)

Making CA certificate ...
====
openssl req  -new -keyout ./demoCA/private/cakey.pem -out ./demoCA/careq.pem
...+.....+......+.......+...+..+.+..+.......+.....+.+.....+....+...+.....+...+.+                                                                                ...+...+..............+.+........+.+......+..................+..+............+.+                                                                                ......+.....+....+.....................+...+..+.+........+.......+...+.....+....                                                                                ...........+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...                                                                                .....+.......+...........+.......+........+...+....+...+.....+.......+++++++++++                                                                                ++++++++++++++++++++++++++++++++++++++++++++++++++++++*............+....+......+                                                                                .....+....+.....+................+...+.....+.......+........+.+.....+....+.....+                                                                                ..........+.........+...............................................+......+....                                                                                ........+..........+...+...+..+..........+..+...+.......+.....+.+..+............                                                                                ...+..........+.........+.........+.........+.....+..................+...+......                                                                                .+............+..+...+...+....+.........+.........+..+.........+.+...........+..                                                                                .+.+......+..................+..+.......+......+..+....+.........+..+...+....+..                                                                                .+..+......+.+...+..+....+...........+...+...+.........+.+..+......+.+..........                                                                                .+...+....+...+...+......+........+......+....+...+.....+...+.........+.......++                                                                                +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
..+................+...+...+.....+.......+........++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++++++++++++++++++*.....+..+...+...+..................+.+......                                                                                ........+.+........+.+.....+.+......+...+............+.....+..........+...+.....                                                                                ......+.+.................+.+.....++++++++++++++++++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++*...+..+.........+.+..............+....+......+........+.....                                                                                ..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:A Coruna
Locality Name (eg, city) []:A Coruna
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UDC
Organizational Unit Name (eg, section) []:FIC
Common Name (e.g. server FQDN or YOUR name) []:ivan
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
==> 0
====
====
openssl ca  -create_serial -out ./demoCA/cacert.pem -days 1095 -batch -keyfile .                                                                                /demoCA/private/cakey.pem -selfsign -extensions v3_ca -infiles ./demoCA/careq.pe                                                                                m
Using configuration from /usr/lib/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            4c:75:8e:61:ee:d2:eb:69:81:67:c2:8c:84:34:3c:5d:37:5f:85:fa
        Validity
            Not Before: Nov 28 16:46:49 2023 GMT
            Not After : Nov 27 16:46:49 2026 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = A Coruna
            organizationName          = UDC
            organizationalUnitName    = FIC
            commonName                = ivan
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
            X509v3 Authority Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
            X509v3 Basic Constraints: critical
                CA:TRUE
Certificate is to be certified until Nov 27 16:46:49 2026 GMT (1095 days)

Write out database with 1 new entries
Database updated
==> 0
====
```
##### b. Cree su propio certificado para ser firmado por la Autoridad Certificadora. Bueno, y fírmelo. 
+ ./CA.pl -newreq-nodes
```
====
openssl req  -new -nodes -keyout newkey.pem -out newreq.pem -days 365
Ignoring -days without -x509; not generating a certificate
..+....+...+........+...+.+...+..+.............+...+.....+....+...........+...++                                                                                +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+.......+....                                                                                .+.+..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*...+...+                                                                                ....................+.......+...+........+.+..............+....+..+...+.+..+....                                                                                +...+.....+.......+......+...+.....+.+........+.+......+.....+.+........+.+...+.                                                                                ..+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
.+..+...+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*......                                                                                ........+....+..+....+...+...+........++++++++++++++++++++++++++++++++++++++++++                                                                                +++++++++++++++++++++++*.......+..+.......+...........+.........+.+...........+.                                                                                +...+.....+.+.............................+....+...........+......+.............                                                                                +..+....+.........+......+.....+......+.+.........+......+...+..+....+..........                                                                                ....+.+.....+.........+....+..+.+...+..+.........+.........+....+...+..+.+..+...                                                                                +.+...+.....+.+............+.....+...+......+...............+.+........+.......+                                                                                ..+.......+...........+..........+........+....+.....+............+.+..+........                                                                                .......+...+..........+.....+...+......+...+.......+...+......+.....+....+......                                                                                ..+...+................+........+......+.........+...+.......+...+...+..+.......                                                                                +........+....+........+.+..+...............+.......+......+......+.....+.+.....                                                                                ...+.+.....+......+...+.+...+...........+....+...+..+............+...+......+...                                                                                ....+.....+.........+.+........+.+.....+..........+...............+...+...+.....                                                                                ............+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:ES
State or Province Name (full name) [Some-State]:A Coruna
Locality Name (eg, city) []:A Coruna
Organization Name (eg, company) [Internet Widgits Pty Ltd]:UDC
Organizational Unit Name (eg, section) []:FIC
Common Name (e.g. server FQDN or YOUR name) []:ivan
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
==> 0
====
Request is in newreq.pem, private key is in newkey.pem
```
+ ./CA.pl -sign
```
====
openssl ca  -policy policy_anything -out newcert.pem -infiles newreq.pem
Using configuration from /usr/lib/ssl/openssl.cnf
Enter pass phrase for ./demoCA/private/cakey.pem:
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number:
            4c:75:8e:61:ee:d2:eb:69:81:67:c2:8c:84:34:3c:5d:37:5f:85:fb
        Validity
            Not Before: Nov 28 16:54:31 2023 GMT
            Not After : Nov 27 16:54:31 2024 GMT
        Subject:
            countryName               = ES
            stateOrProvinceName       = A Coruna
            localityName              = A Coruna
            organizationName          = UDC
            organizationalUnitName    = FIC
            commonName                = ivan
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Subject Key Identifier:
                83:8E:4C:5A:EC:62:A1:A5:FE:EF:43:D6:64:C7:64:26:A4:AB:00:56
            X509v3 Authority Key Identifier:
                AE:06:D4:82:42:3C:E0:D1:7A:BD:11:25:8C:41:86:30:BE:1E:3C:53
Certificate is to be certified until Nov 27 16:54:31 2024 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Database updated
==> 0
====
Signed certificate is in newcert.pem
```
##### c. Configure su Apache para que únicamente proporcione acceso a un determinado directorio del árbol web bajo la condición del uso de SSL. Considere que si su la clave privada está cifrada en el proceso de arranque su máquina le solicitará la correspondiente frase de paso, pudiendo dejarla inalcanzable para su sesión ssh de trabajo.
+ a2enmod ssl
+ cp newkey.pem newcert.pem demoCA/cacert.pem /etc/apache2/ssl
+ cat /etc/apache2/sites-available/default-ssl.conf 
```
<VirtualHost *:443>
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf

        #   SSL Engine Switch:
        #   Enable/Disable SSL for this virtual host.
        SSLEngine on

        #   A self-signed (snakeoil) certificate can be created by installing
        #   the ssl-cert package. See
        #   /usr/share/doc/apache2/README.Debian.gz for more info.
        #   If both key and certificate are stored in the same file, only the
        #   SSLCertificateFile directive is needed.
        SSLCertificateFile      /etc/apache2/ssl/newcert.pem
        SSLCertificateKeyFile   /etc/apache2/ssl/newkey.pem
        SSLCACertificateFile    /etc/apache2/ssl/cacert.pem

        #   Server Certificate Chain:
        #   Point SSLCertificateChainFile at a file containing the
        #   concatenation of PEM encoded CA certificates which form the
        #   certificate chain for the server certificate. Alternatively
        #   the referenced file can be the same as SSLCertificateFile
        #   when the CA certificates are directly appended to the server
        #   certificate for convinience.
        #SSLCertificateChainFile /etc/apache2/ssl.crt/server-ca.crt

        #   Certificate Authority (CA):
        #   Set the CA certificate verification path where to find CA
        #   certificates for client authentication or alternatively one
        #   huge file containing all of them (file must be PEM encoded)
        #   Note: Inside SSLCACertificatePath you need hash symlinks
        #         to point to the certificate files. Use the provided
        #         Makefile to update the hash symlinks after changes.
        #SSLCACertificatePath /etc/ssl/certs/
        #SSLCACertificateFile /etc/apache2/ssl.crt/ca-bundle.crt

        #   Certificate Revocation Lists (CRL):
        #   Set the CA revocation path where to find CA CRLs for client
        #   authentication or alternatively one huge file containing all
        #   of them (file must be PEM encoded)
        #   Note: Inside SSLCARevocationPath you need hash symlinks
        #         to point to the certificate files. Use the provided
        #         Makefile to update the hash symlinks after changes.
        #SSLCARevocationPath /etc/apache2/ssl.crl/
        #SSLCARevocationFile /etc/apache2/ssl.crl/ca-bundle.crl

        #   Client Authentication (Type):
        #   Client certificate verification type and depth.  Types are
        #   none, optional, require and optional_no_ca.  Depth is a
        #   number which specifies how deeply to verify the certificate
        #   issuer chain before deciding the certificate is not valid.
        #SSLVerifyClient require
        #SSLVerifyDepth  10

        #   SSL Engine Options:
        #   Set various options for the SSL engine.
        #   o FakeBasicAuth:
        #    Translate the client X.509 into a Basic Authorisation.  This means                                                                                 that
        #    the standard Auth/DBMAuth methods can be used for access control.                                                                                  The
        #    user name is the `one line' version of the client's X.509 certifica                                                                                te.
        #    Note that no password is obtained from the user. Every entry in the                                                                                 user
        #    file needs this password: `xxj31ZMTZzkVA'.
        #   o ExportCertData:
        #    This exports two additional environment variables: SSL_CLIENT_CERT                                                                                 and
        #    SSL_SERVER_CERT. These contain the PEM-encoded certificates of the
        #    server (always existing) and the client (only existing when client
        #    authentication is used). This can be used to import the certificate                                                                                s
        #    into CGI scripts.
        #   o StdEnvVars:
        #    This exports the standard SSL/TLS related `SSL_*' environment varia                                                                                bles.
        #    Per default this exportation is switched off for performance reason                                                                                s,
        #    because the extraction step is an expensive operation and is usuall                                                                                y
        #    useless for serving static content. So one usually enables the
        #    exportation for CGI and SSI requests only.
        #   o OptRenegotiate:
        #    This enables optimized SSL connection renegotiation handling when S                                                                                SL
        #    directives are used in per-directory context.
        #SSLOptions +FakeBasicAuth +ExportCertData +StrictRequire
        <FilesMatch "\.(?:cgi|shtml|phtml|php)$">
                SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                SSLOptions +StdEnvVars
        </Directory>

        #   SSL Protocol Adjustments:
        #   The safe and default but still SSL/TLS standard compliant shutdown
        #   approach is that mod_ssl sends the close notify alert but doesn't wa                                                                                it for
        #   the close notify alert from client. When you need a different shutdo                                                                                wn
        #   approach you can use one of the following variables:
        #   o ssl-unclean-shutdown:
        #    This forces an unclean shutdown when the connection is closed, i.e.                                                                                 no
        #    SSL close notify alert is send or allowed to received.  This violat                                                                                es
        #    the SSL/TLS standard but is needed for some brain-dead browsers. Us                                                                                e
        #    this when you receive I/O errors because of the standard approach w                                                                                here
        #    mod_ssl sends the close notify alert.
        #   o ssl-accurate-shutdown:
        #    This forces an accurate shutdown when the connection is closed, i.e                                                                                . a
        #    SSL close notify alert is send and mod_ssl waits for the close noti                                                                                fy
        #    alert of the client. This is 100% SSL/TLS standard compliant, but i                                                                                n
        #    practice often causes hanging connections with brain-dead browsers.                                                                                 Use
        #    this only for browsers where you know that their SSL implementation
        #    works correctly.
        #   Notice: Most problems of broken clients are also related to the HTTP
        #   keep-alive facility, so you usually additionally want to disable
        #   keep-alive for those clients, too. Use variable "nokeepalive" for th                                                                                is.
        #   Similarly, one has to force some clients to use HTTP/1.0 to workarou                                                                                nd
        #   their broken HTTP/1.1 implementation. Use variables "downgrade-1.0"                                                                                 and
        #   "force-response-1.0" for this.
        # BrowserMatch "MSIE [2-6]" \
        #       nokeepalive ssl-unclean-shutdown \
        #       downgrade-1.0 force-response-1.0

</VirtualHost>
```
+ cp cacert.pem /usr/local/share/ca-certificates/ca.crt
+ update-ca-certificates     
+ lynx https://ivan

### 3
Server:
+ openvpn --remote 10.11.49.49 --dev tun1 --ifconfig 10.9.8.1 10.9.8.2

Cliente:
+ openvpn --remote 10.11.49.56 --dev tun1 --ifconfig 10.9.8.2 10.9.8.1

### 7. Ejecute la utilidad de auditoría de seguridad lynis en su sistema y trate de identificar las acciones de securización detectadas así como los consejos sobre las que se deberían contemplar.
+ wget https://downloads.cisofy.com/lynis/lynis-3.0.9.tar.gz 
+ tar xvf lynis-3.0.9.tar.gz
+ cd lynis
+ ./lynis audit system

Sugerencias: 
```
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowTcpForwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option AllowTcpForwarding;field:AllowTcpForwarding;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|ClientAliveCountMax (set 3 to 2)|-|
details[]=SSH-7408|sshd|desc:sshd option ClientAliveCountMax;field:ClientAliveCountMax;prefval:2;value:3;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|LogLevel (set INFO to VERBOSE)|-|
details[]=SSH-7408|sshd|desc:sshd option LogLevel;field:LogLevel;prefval:VERBOSE;value:INFO;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxAuthTries (set 6 to 3)|-|
details[]=SSH-7408|sshd|desc:sshd option MaxAuthTries;field:MaxAuthTries;prefval:3;value:6;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|MaxSessions (set 10 to 2)|-|
details[]=SSH-7408|sshd|desc:sshd option MaxSessions;field:MaxSessions;prefval:2;value:10;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|Port (set 22 to )|-|
details[]=SSH-7408|sshd|desc:sshd option Port;field:Port;prefval:;value:22;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|TCPKeepAlive (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option TCPKeepAlive;field:TCPKeepAlive;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|X11Forwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option X11Forwarding;field:X11Forwarding;prefval:NO;value:YES;|
suggestion[]=SSH-7408|Consider hardening SSH configuration|AllowAgentForwarding (set YES to NO)|-|
details[]=SSH-7408|sshd|desc:sshd option AllowAgentForwarding;field:AllowAgentForwarding;prefval:NO;value:YES;|

```