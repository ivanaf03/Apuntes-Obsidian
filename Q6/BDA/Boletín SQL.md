[[Bases de datos avanzadas]]

## 1.Control transaccional

```sql
CREATE TABLE XEMP AS
SELECT * 
FROM EMP 
WHERE ENAME IN ('SMITH', 'KING');
```

```sql
UPDATE XEMP 
SET SAL = 1000 
WHERE ENAME = 'SMITH';
```

```sql
UPDATE XEMP
SET COMM = 100 
WHERE ENAME = 'SMITH';
```

```sql
UPDATE XEMP
SET SAL = 4000
WHERE ENAME='KING';
```

```sql
UPDATE XEMP
SET SAL = 1500
WHERE ENAME='SMITH';
```

```sql
UPDATE XEMP
SET SAL = 1350
WHERE ENAME='SMITH';
```

```sql
UPDATE XEMP
SET SAL = 4700
WHERE ENAME='KING';
```

```sql
DELETE FROM XEMP;
```

```sql
INSERT INTO XEMP 
SELECT * FROM EMP
WHERE ENAME='KING';
```

```sql
UPDATE XEMP
SET SAL = SAL*2
WHERE ENAME='KING';
```

```sql
INSERT INTO XEMP (EMPNO, ENAME, SAL)
VALUES (1234, NOBODY, 1000);
```

```sql
UPDATE XEMP
SET SAL = 2000
WHERE ENAME='NOBODY';
```

```sql
SET TRANSACTION ISOLATIONLEVEL SERIALIZABLE;
```

```sql
UPDATE XEMP
SET SAL = 3000
WHERE ENAME='KING';
```

```sql
SELECT *
FROM XEMP
WHERE ENAME = 'KING';

UPDATE EMP
SET SAL = SAL * 2
WHERE ENAME = 'KING';
```

```sql
ALTER SESSION SET READ ONLY;
```

## 2.Optimización

```
CREATE TABLE DEPT
       (DEPTNO NUMBER(2) CONSTRAINT PK_DEPT PRIMARY KEY,
        DNAME VARCHAR2(14) ,
        LOC VARCHAR2(13) ) ;

CREATE TABLE EMP
       (EMPNO NUMBER(4) CONSTRAINT PK_EMP PRIMARY KEY,
        ENAME VARCHAR2(10),
        JOB VARCHAR2(9),
        MGR NUMBER(4),
        HIREDATE DATE,
        SAL NUMBER(7,2),
        COMM NUMBER(7,2),
        DEPTNO NUMBER(2) CONSTRAINT FK_DEPTNO REFERENCES DEPT);

INSERT INTO DEPT VALUES
        (10,'ACCOUNTING','NEW YORK');
INSERT INTO DEPT VALUES (20,'RESEARCH','DALLAS');
INSERT INTO DEPT VALUES
        (30,'SALES','CHICAGO');
INSERT INTO DEPT VALUES
        (40,'OPERATIONS','BOSTON');

INSERT INTO EMP VALUES
(7369,'SMITH','CLERK',7902,to_date('17-12-1980','dd-mm-yyyy'),800,NULL,20);
INSERT INTO EMP VALUES
(7499,'ALLEN','SALESMAN',7698,to_date('20-2-1981','dd-mm-yyyy'),1600,300,30);
INSERT INTO EMP VALUES
(7521,'WARD','SALESMAN',7698,to_date('22-2-1981','dd-mm-yyyy'),1250,500,30);
INSERT INTO EMP VALUES
(7566,'JONES','MANAGER',7839,to_date('2-4-1981','dd-mm-yyyy'),2975,NULL,20);
INSERT INTO EMP VALUES
(7654,'MARTIN','SALESMAN',7698,to_date('28-9-1981','dd-mm-yyyy'),1250,1400,30);
INSERT INTO EMP VALUES
(7698,'BLAKE','MANAGER',7839,to_date('1-5-1981','dd-mm-yyyy'),2850,NULL,30);
INSERT INTO EMP VALUES
(7782,'CLARK','MANAGER',7839,to_date('9-6-1981','dd-mm-yyyy'),2450,NULL,10);
INSERT INTO EMP VALUES
(7788,'SCOTT','ANALYST',7566,to_date('13-7-87','dd-mm-yy')-85,3000,NULL,20);
INSERT INTO EMP VALUES
(7839,'KING','PRESIDENT',NULL,to_date('17-11-1981','dd-mm-yyyy'),5000,NULL,10);
INSERT INTO EMP VALUES
(7844,'TURNER','SALESMAN',7698,to_date('8-9-1981','dd-mm-yyyy'),1500,0,30);
INSERT INTO EMP VALUES
(7876,'ADAMS','CLERK',7788,to_date('13-7-87', 'dd-mm-yy')-51,1100,NULL,20);
INSERT INTO EMP VALUES
(7900,'JAMES','CLERK',7698,to_date('3-12-1981','dd-mm-yyyy'),950,NULL,30);
INSERT INTO EMP VALUES
(7902,'FORD','ANALYST',7566,to_date('3-12-1981','dd-mm-yyyy'),3000,NULL,20);
INSERT INTO EMP VALUES
(7934,'MILLER','CLERK',7782,to_date('23-1-1982','dd-mm-yyyy'),1300,NULL,10);

alter table emp add constraint fk_emp foreign key(mgr) references emp(empno);

CREATE TABLE pro (
  prono NUMBER(4) NOT NULL,
  pname  VARCHAR2(10),
  loc    VARCHAR2(13),
  deptno NUMBER(2));

CREATE TABLE emppro (
  empno  NUMBER(4) NOT NULL,
  prono NUMBER(4) NOT NULL,
  hours  NUMBER(2));

INSERT INTO pro VALUES (1001, 'P1', 'BOSTON', 20);
INSERT INTO pro VALUES (1004, 'P4', 'CHICAGO', 30);
INSERT INTO pro VALUES (1005, 'P5', 'CHICAGO', 30);
INSERT INTO pro VALUES (1006, 'P6', 'LOS ANGELES', 30);
INSERT INTO pro VALUES (1008, 'P8', 'NEW YORK', 30);

INSERT INTO emppro VALUES (7499,1004,15);
INSERT INTO emppro VALUES (7499,1005,12);
INSERT INTO emppro VALUES (7521,1004,10);
INSERT INTO emppro VALUES (7521,1008,8);
INSERT INTO emppro VALUES (7654,1001,16);
INSERT INTO emppro VALUES (7654,1006,15);
INSERT INTO emppro VALUES (7654,1008,5);
INSERT INTO emppro VALUES (7844,1005,6);
INSERT INTO emppro VALUES (7934,1001,4);
```

```sql
SET AUTOTRACE TRACEONLY EXPLAIN;
```

```sql
CALL DBMS_STATS.GATHER_SCHEMA_STATS('"ivan.alvarez.fernandez"')
```

```sql
EXPLAIN PLAN FOR SELECT ENAME, DNAME FROM EMP NATURAL JOIN DEPT;
```

```sql
SELECT FROM TABLE(DBMS_XPLAN.DISPLAY);
```

```sql
SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY(FORMAT => 'ALL'));
```

```sql
EXPLAIN PLAN FOR 
SELECT * FROM EMP; 

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

SET AUTOTRACE TRACEONLY EXPLAIN;

SELECT * FROM EMP;
```

```sql
SELECT /*+ FULL(emp) */ * 
FROM EMP 
WHERE EMPNO=7902;
```

```sql
SELECT EMPNO
FROM EMP
WHERE EMPNO IN (7902, 7839, 5432);
```

```sql
SELECT SAL 
FROM EMP 
WHERE ENAME = 'SMITH';
```

```sql
CREATE INDEX i_emp_ename ON emp(ename);

SELECT SAL 
FROM EMP 
WHERE ENAME = 'SMITH';
```

```sql
SELECT MAX(ENAME)
FROM EMP;
```

Oracle no indexa nulos.

```sql
ALTER TABLE EMP
MODIFY ENAME VARCHAR(10) NOT NULL;
```

```sql
create table ARTIGO AS select * from docencia.artigo; 

create table VENDA AS select * from docencia.venda;
```

```sql
CALL dbms_stats.gather_schema_stats('"ivan.alvarez.fernandez"');
```

```sql
SET AUTOT OFF;
```

Para el primer artículo de la tabla de ventas usa el índice porque accede a muy poquitos datos.

```sql
SELECT * FROM ARTIGO NATURAL JOIN VENDA;
```

```sql
SELECT /*+ USE_NL(ARTIGO VENDA)*/ * FROM ARTIGO NATURAL JOIN VENDA; 

SELECT /*+ USE_MERGE(ARTIGO VENDA)*/ * FROM ARTIGO NATURAL JOIN VENDA; 

SELECT /*+ USE_HASH(ARTIGO VENDA)*/ * FROM ARTIGO NATURAL JOIN VENDA; 

SELECT /*+ ALL_ROWS*/ * FROM ARTIGO NATURAL JOIN VENDA;
```

```sql
SELECT /*+ FIRST_ROWS(100)*/ * FROM ARTIGO NATURAL JOIN VENDA;
```

```sql
ALTER TABLE VENDA DISABLE COSNTRAINT FK_ARTIGO;
```
